class t{activeClass(t,e,i,a){if(!t)return;const r=new t(e,i,a);return r.mesh&&this.scene.add(r.mesh),r.update&&this.scene.addUpdate(r.update.bind(r)),r.fixUpdate&&this.scene.addFixUpdate(r.fixUpdate.bind(r)),r.slowUpdate&&this.scene.addSlowUpdate(r.slowUpdate.bind(r)),r}activeUIClass(t,e,i){const a=new t(e,i);return a.mesh&&this.UIScene.add(a.mesh),a.update&&this.scene.addUpdate(a.update.bind(a)),a.fixUpdate&&this.scene.addFixUpdate(a.fixUpdate.bind(a)),a.slowUpdate&&this.scene.addSlowUpdate(a.slowUpdate.bind(a)),a}}let e={halfPI:Math.PI/2,twoPI:2*Math.PI,vec:new THREE.Vector3,dir:new THREE.Vector3,ray:new THREE.Raycaster,box:new THREE.Box3,l:(...t)=>null,sleep:function(t){return new Promise(((t,e)=>{t()}),1e3*t)},ms:t=>new Promise(((t,e)=>{t()}),t),getQueryParams:function(){var t=window.location.search;if(t){t=t.split("+").join(" ");for(var e,i={},a=/[?&]?([^=]+)=([^&]*)/g;e=a.exec(t);)i[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return i}}};e.quickSort=(t,e)=>{const i=function t(e,i,r){var n,o=e.length;(i="number"!=typeof i?0:i)<(r="number"!=typeof r?o-1:r)&&(n=function(t,e,i){for(var r=e,n=r+1,o=n;o<=i;o++)t[o]<t[r]&&(a(t,o,n),n++);return a(t,r,n-1),n-1}(e,i,r),t(e,i,n-1),t(e,n+1,r));return e}(i);return isR?i.reverse():i;function a(t,e,i){var a=t[e];t[e]=t[i],t[i]=a}},e.normalize=function(t,e,i,a,r){return a+(Math.max(Math.min(t,i),e)-e)/(i-e)*(r-a)},e.clamp=function(t,e=0,i=1){return Math.min(Math.max(t,e),i)},e.uniqueArray=function(t){return t.filter(((t,e,i)=>i.indexOf(t)===e))},e.toDecimal=function(t){var e=parseFloat(t);if(!isNaN(e))return e=~~(100*t)/100},e.getMinusInRange=function(t,e,i){var a=i;return t<-e?a=i:(t>e||t<e&&t>0)&&(a=-i),a},e.UUID=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})),e.isMobile=function(){var t=!1;return(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(t=!0),t},e._typeof=function(t){var e={};return"Boolean Number String Function Array Date RegExp Object Error".split(" ").forEach((function(t,i){e["[object "+t+"]"]=t.toLowerCase()})),null===t?String(t):"object"==typeof t||"function"==typeof t?e[e.toString.call(t)]||"object":typeof t};var i=function(){var t={};function e(e){return t[Object.prototype.toString.call(e)]||"object"}return["Null","Undefined","Number","Boolean","String","Object","Function","Array","RegExp","Date"].forEach((function(e){t["[object "+e+"]"]=e.toLowerCase()})),{isType:function(t,i){return e(t)===i},getType:e}}();e.deepCopy=function(t,a){if(null===t||"object"!=typeof t)return t;var r,n,o,s=i.isType(t,"array")?[]:{};for(r in t)n=t[r],o=i.getType(n),s[r]=!a||"array"!==o&&"object"!==o?n:e.deepCopy(n);return s},e.isNull=function(t){if(null==t)return!0;return"string"===e._typeof(t)&&""===(t=e.delSpace(t))},e.delSpace=function(t){return t=(t=t.trim()).replace(/\s+/g,"")},e.getRandomIntInRange=function(t,e){return parseInt(Math.random()*e,10)+t},e.Olength=function(t){return Object.keys(t).length},e.degToDirection=function(t){t<0&&(t+=360);var e=Math.floor(t/45+.5),i=[1,2,3,4,5,6,7,8];return(e%=16)>=i.length&&(e=0),i[e]},e.angleToRadian=function(t){return(t=(t=t>=360?t-360:t)<0?t+360:t)*Math.PI/180},e.radianToAngle=function(t){return 180/(Math.PI/t)},e.getAngle=function(t,e,i,a){var r=i-t,n=a-e,o=r/Math.sqrt(Math.pow(r,2)+Math.pow(n,2)),s=Math.acos(o),h=180/(Math.PI/s);return~~(h=h||0)},e.getAngle2=function(t,e,i,a){var r=i-t,n=a-e;let o=Math.atan2(n,r);return o/=Math.PI/180,o-=90,o=-o,o},e.getRadian=function(t,e,i,a){return Math.atan2(a-e,i-t)},e.dirToRadian=function(t){return Math.atan2(t.z,t.x)},e.radianToDir=function(t){return{x:Math.cos(t),z:Math.sin(t)}},e.getDistance=function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.z-e.z,2))},e.get3DDistance=function(t,e){var i=t.x-e.x,a=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+a*a+r*r)},e.getContactPoint=function(t,e,i){if(!t)return;i=i?i.normalize():{x:0,y:-1,z:0},this.vec.set(e.x,e.y,e.z),this.dir.set(i.x,i.y,i.z),this.ray.set(this.vec,this.dir);const a=this.ray.intersectObject(t);return!a||a.length<=0?void 0:a[0]},e.getDisToLine=function(t,e,i){function a(t){return t*t}function r(t,e){return a(t.x-e.x)+a(t.z-e.z)}var n=r(e,i);if(0==n)return r(t,e);var o=((t.x-e.x)*(i.x-e.x)+(t.z-e.z)*(i.z-e.z))/n;return r(t,o<0?e:o>1?i:{x:e.x+o*(i.x-e.x),z:e.z+o*(i.z-e.z)})},e.getDisToLine3D=function(t,e,i){function a(t){return t*t}function r(t,e){return a(t.x-e.x)+a(t.y-t.y)+a(t.z-e.z)}var n=r(e,i);if(0===n)return r(t,e);var o=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y)+(t.z-e.z)*(i.z-e.z))/n;return r(t,o<0?e:o>1?i:{x:e.x+o*(i.x-e.x),y:e.y+o*(i.y-e.y),z:e.z+o*(i.z-e.z)})},e.CircularLayout=function(t,e,i){i=i||{x:0,y:0};var a,r,n=[];for(a=r=0;r<t;a=++r){var o=i.x+e*Math.sin(2*Math.PI*a/t),s=i.y+e*Math.cos(2*Math.PI*a/t);n.push({x:o,y:s})}return n},e.posCircular=function(t,e,i){return{x:t*Math.sin(2*Math.PI*e/i),z:t*Math.cos(2*Math.PI*e/i)}},e.randomInSphere=function(t){return e.vec.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize().multiplyScalar(t*Math.random())},e.randomInSphereSurface=function(t,i){let a=-.5*Math.random();return i&&a<-.2&&(a=-a),e.vec.set(Math.random()-.5,a,Math.random()-.5).normalize().multiplyScalar(t)},e.randomInCircle=function(t,i){return e.vec.set(Math.random()-.5,0,Math.random()-.5).normalize().multiplyScalar(t-i+i*Math.random())},e.randomPosInRadius=function(t,e){var i=360*Math.random(),a=Math.sin(2*Math.PI/360)*i,r=Math.sin(a)*e,n=Math.cos(a)*e;return t.x+=n,t.y+=r,t},e.forward=function(t,e,i){t.z+=Math.sin(e)*i,t.x+=Math.cos(e)*i},e.MLength=function(t,e){e=e||THREE.Mesh;var i=0;return t.traverse((function(a){a instanceof e&&(a.name?i+=1:t.remove(a))})),i},e.getPointInBetweenByPerc=function(t,i,a){a=a||.5;let r=e.vec;r.copy(i);let n=r.sub(t),o=n.length();return n=n.normalize().multiplyScalar(o*a),r.copy(t),r.add(n),r},e.posRound=function(t){return{x:~~t.x,y:~~t.y,z:~~t.z}},e.loadCollada=function(t,e){var i=new THREE.ColladaLoader;i.options.convertUpAxis=!0,i.load(t,(function(t){var i=t.scene;i.traverse((function(t){t instanceof THREE.SkinnedMesh&&new THREE.Animation(t,t.geometry.animation).play()})),i.scale.x=i.scale.y=i.scale.z=.002,i.position.x=-1,i.updateMatrix(),e(i)}))},e.position2Screen=function(t,i,a,r){if(t&&i&&t.matrixWorld)return e.vec.setFromMatrixPosition(t.matrixWorld),e.vec.project(i),e.vec.x=e.vec.x*a,e.vec.y=-e.vec.y*r,e.vec},e.removeMesh=function(t,e){var i=t.getObjectByName(e.name);t.remove(i),animate()},e.getMeshParameters=function(t){return t.geometry.parameters},e.getMeshSize=function(t,e){this.box.setFromObject(t).getSize(e)},e.ab2str=function(t){return String.fromCharCode.apply(null,new Uint8Array(t))},e.str2ab=function(t){for(var e=new ArrayBuffer(1*t.length),i=new Uint8Array(e),a=0,r=t.length;a<r;a++)i[a]=t.charCodeAt(a);return e},e.str2ab16=function(t){for(var e=new ArrayBuffer(2*t.length),i=new Uint16Array(e),a=0,r=t.length;a<r;a++)i[a]=t.charCodeAt(a);return e},e.ab162str=function(t){return String.fromCharCode.apply(null,new Uint16Array(t))},e.Utf8ArrayToStr=function(t){var e,i,a,r,n,o;for(e="",a=t.length,i=0;i<a;)switch((r=t[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:e+=String.fromCharCode(r);break;case 12:case 13:n=t[i++],e+=String.fromCharCode((31&r)<<6|63&n);break;case 14:n=t[i++],o=t[i++],e+=String.fromCharCode((15&r)<<12|(63&n)<<6|(63&o)<<0)}return e};class a{emassivRed(){return"\n        uniform float emissiveIntensity;\n         vec3 emassivRed(vec3 c1, vec3 c2){\n            // vec3 emassiv = vec3(emissiveIntensity, emissiveIntensity * 0.5, 0.0);\n            vec3 emassiv = vec3(emissiveIntensity, -emissiveIntensity * 0.25, -emissiveIntensity * 0.5);\n            return c1 * c2 + emassiv ;\n         }\n        "}lerp(){return"\n        vec3 lerp(vec3 a, vec3 b, float w) {\n            return (a + w*(b-a));\n        }\n        "}transformMesh(){return"\nvec3 transformMesh( vec3 position, vec3 T, vec4 R, vec3 S ) {\n\n    position *= S;\n\n    position += 2.0 * cross( R.xyz, cross( R.xyz, position ) + R.w * position );\n\n    position += T;\n\n    return position;\n}\n        "}tween(t=10){return`\n\n        #ifndef HALF_PI\n        #define HALF_PI 1.5707963267948966\n        #endif\n\n        float easeIn(float t) {\n            return t == 0.0 ? t : pow(2.0, ${t=parseInt(t)+".0"} * (t - 1.0));\n        }\n\n        float easeOut(float t) {\n            return t == 1.0 ? t : 1.0 - pow(2.0, -${t} * t);\n        }\n\n        float sineOut(float t) {\n            return sin(t * HALF_PI);\n        }\n\n        float elasticIn(float t) {\n            return sin(13.0 * t * HALF_PI) * pow(2.0, ${t} * (t - 1.0));\n        }\n\n        float elasticOut(float t) {\n            return sin(-13.0 * (t + 1.0) * HALF_PI) * pow(2.0, -${t} * t) + 1.0;\n          }\n        `}fsPointRotation(){return"\n        vec4 fsPointRotation(sampler2D pointTexture, float vRotation){\n            float mid = 0.5;\n            vec2 rotated = vec2(cos(vRotation) * (gl_PointCoord.x - mid) + sin(vRotation) * (gl_PointCoord.y - mid) + mid,\n                              cos(vRotation) * (gl_PointCoord.y - mid) - sin(vRotation) * (gl_PointCoord.x - mid) + mid);\n            vec4 rotatedTexture = texture2D( pointTexture,  rotated);\n            return rotatedTexture;\n        }\n        "}vsDirLightColor(){return"\n#if NUM_DIR_LIGHTS > 0\nstruct DirectionalLight {\n   vec3 direction;\n   vec3 color;\n   int shadow;\n   float shadowBias;\n   float shadowRadius;\n   vec2 shadowMapSize;\n   };\n   uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n#endif\n\nvec3 vsDirLightColor(){\nvec3 wPosition       = position;\nvec3 wV              = cross(orientation.xyz, wPosition);\nwPosition            = offset + wV * 2.0 * orientation.w + cross(orientation.xyz, wV) * 2.0 + wPosition;\nvec4 ecPosition      = modelViewMatrix * vec4(wPosition, 1.0);\n// vUv                  = uv;\ngl_Position          = projectionMatrix * ecPosition;\n\n    // transform normal vector to world space\nvec3 wNPosition      = position + normal;\nvec3 wNV             = cross(orientation.xyz, wNPosition);\nwNPosition           = offset + wNV * 2.0 * orientation.w + cross(orientation.xyz, wNV) * 2.0 + wNPosition;\nvec3 ecNormal        = normalize(mat3(modelViewMatrix) * (wNPosition - wPosition));\n\n// diffuse light\nvec3  ecToLight      = normalize(directionalLights[0].direction);\nfloat NdotL          = max(0.0, dot(ecNormal, ecToLight));\nvec3 vLightFactor    = NdotL * directionalLights[0].color; \nreturn vLightFactor;\n}\n\n"}}class r{constructor(){this._i=null,this._t=null}addText(t){const e=this.makeTextTexture(t),i=e.context,a=e.texture,r=new THREE.SpriteMaterial({color:16777215,map:a}),n=new THREE.Sprite(r);return n.scale.set(t.width,t.height,1),{mesh:n,context:i,texture:a}}changeText(t,e,i,a){const r=e.canvas.width,n=e.canvas.height;e.clearRect(0,0,r,n),this.showBG&&(e.beginPath(),e.rect(0,0,r,n),e.fillStyle="rgba(250,100,100,0.5)",e.fill()),this.printAtWordWrap(e,t,r/2,n/4,a||n/4),i.needsUpdate=!0}printAtWordWrap(t,e,i,a,r){if(void 0===e)return;let n=e;try{n=n.split("\n")}catch(t){}if(!n||""===n)return;let o=[];for(this._i=0;this._i<n.length;this._i++)this._t=n[this._i],""!==this._t&&o.push(this._t);for(this._i=0;this._i<o.length;this._i++)t.strokeText(o[this._i],i,a+this._i*r),t.fillText(o[this._i],i,a+this._i*r)}changeTextOpt(t){const e=t.context.canvas.width,i=t.context.canvas.height;t.context.clearRect(0,0,e,i),t.isShowBG&&(t.context.beginPath(),t.context.rect(0,0,e,i),t.context.fillStyle=t.bgColor||"rgba(250,100,100,0.5)",t.context.fill());let a="";t.fontWeight&&(a+=t.fontWeight+" "),a+=t.fontSize||"32px",a+="/1.5 ",a+=t.fontFamily||"AppleSDGothicNeo, PingFangHK, Helvetica",t.context.font=a,t.context.fillStyle=t.color,t.context.textAlign=t.textAlign||"center",t.context.textBaseline="middle";const r="center"===t.context.textAlign?e/2:0;this.printAtWordWrap(t.context,t.text,r,i/2,t.lineHeight||i/2),t.texture.needsUpdate=!0}makeTextTexture(t){t.fontSize=t.fontSize||40,t.color=t.color||"rgba(245,245,245,1)",t.fontFamily=t.fontFamily||"AvenirNextCondensed-Bold, Impact, Georgia",t.text=t.text||"",t.textAlign=t.textAlign||"center";const e=DB.isWX?wx.createCanvas():document.createElement("canvas");e.width=t.width||128,e.height=t.height||128;const i=e.getContext("2d");i.font=t.fontSize+"px "+t.fontFamily,i.lineWidth=2,i.textBaseline="middle",i.textAlign=t.textAlign,i.strokeStyle="rgba(10,10,10,1)";const a=t.fontY||t.height/2;i.strokeText(t.text,t.width/2,a),i.fillStyle=t.color,i.fillText(t.text,t.width/2,a),this.showBG&&(i.beginPath(),i.rect(0,0,t.width,t.height),i.fillStyle="rgba(0,0,100,0.2)",i.fill()),i.restore();const r=new THREE.Texture(e);return r.needsUpdate=!0,r.magFilter=THREE.NearestFilter,{canvas:e,context:i,texture:r}}makeTexture(t,e,i,a,r=!1){const n=DB.isWX?wx.createCanvas():document.createElement("canvas");n.width=i,n.height=i;const o=n.getContext("2d");0===e?this.Circle(o,i,a):1===e?this.HollowCircle(o,i,a):2===e?this.Square(o,i,a):3===e?this.CrossHair(o,i,a):4===e?this.Star(o,i,a,!1):5===e?this.Star(o,i,a,!0):6===e?this.nStar(o,i,a,6):7===e?this.GradientCircle(o,i,a):8===e&&this.Point(o,i,a,r);const s=new t.Texture(n);return s.needsUpdate=!0,s}Point(t,e,i,a){const r=e/2,n=e/2,o=e/2;t.arc(r,n,o,0,2*Math.PI,!1);const s=t.createRadialGradient(r,n,o/4,r,n,o),h=a?"rgba(255, 255, 255, 0)":"black";s.addColorStop(1,h),s.addColorStop(0,i),t.fillStyle=s,t.fill()}GradientCircle(t,e,i){const a=e/2,r=e/2,n=e/2;t.arc(a,r,n,0,2*Math.PI,!1);const o=t.createRadialGradient(a,r,n/4,a,r,n);o.addColorStop(0,"black"),o.addColorStop(1,i),t.fillStyle=o,t.fill()}Circle(t,e,i){t.beginPath(),t.arc(e/2,e/2,e/2,0,360,!1),t.fillStyle=i,t.fill(),t.closePath()}HollowCircle(t,e,i){t.beginPath(),t.arc(e/2,e/2,e/2-6,0,360,!1),t.lineWidth=3,t.strokeStyle=i,t.stroke(),t.closePath()}Square(t,e,i){t.fillStyle=i,t.fillRect(0,0,e,e)}CrossHair(t,e,i){let a=e/2,r=e/2;t.moveTo(a,r-e),t.lineTo(a,r+e),t.moveTo(a-e,r),t.lineTo(a+e,r),t.strokeWidth=2,t.strokeStyle=i,t.stroke(),t.beginPath(),t.arc(e/2,e/2,e/2-6,0,360,!1),t.lineWidth=1,t.strokeStyle=i,t.stroke(),t.closePath()}Star(t,e,i,a){const r=180,n=e/2.1,o=e/4,s=e/2,h=e/2;t.beginPath();for(let e=0;e<5;e++)t.lineTo(Math.cos((18+72*e-r)/180*Math.PI)*n+s,-Math.sin((18+72*e-r)/180*Math.PI)*n+h),t.lineTo(Math.cos((54+72*e-r)/180*Math.PI)*o+s,-Math.sin((54+72*e-r)/180*Math.PI)*o+h);t.closePath(),t.lineWidth=3,t.strokeStyle=i,a&&(t.fillStyle=i),t.fill(),t.stroke()}nStar(t,e,i,a){const r=e/2.1,n=e/4,o=e/2,s=e/2;t.lineWidth=3,t.strokeStyle=i,t.beginPath(),t.translate(o,s);for(let e=0;e<a;e++)t.lineTo(Math.cos(2*(1/4+e)*Math.PI/a)*r,-Math.sin(2*(1/4+e)*Math.PI/a)*r),t.lineTo(Math.cos(2*(3/4+e)*Math.PI/a)*n,-Math.sin(2*(3/4+e)*Math.PI/a)*n);t.closePath(),t.stroke()}addIcon(t,e){const i=new THREE.SpriteMaterial;t&&(i.map=t);const a=new THREE.Sprite(i);return a.scale.set(e,e,1),a.matrixAutoUpdate=!1,a}addIcon2(t,e,i,a){const r=DB.isWX?wx.createCanvas():document.createElement("canvas");r.width=e||128,r.height=e||128;const n=r.getContext("2d");var o=new Image;o.src=t,o.onload=function(){n.drawImage(o,0,0);let t=n.getImageData(0,0,o.width,o.height);for(var s=0,h=t.data.length;s<h;s+=4)0!==t.data[s+3]&&(t.data[s]=255,t.data[s+1]=255,t.data[s+2]=255,t.data[s+3]-=80);n.clearRect(0,0,e,e),n.putImageData(t,0,0);const l=new THREE.Texture(r);l.needsUpdate=!0;const c=new THREE.SpriteMaterial({map:l}),m=new THREE.Sprite(c);m.scale.set(i,i,1),a(m)}}makeMap(t,e=60){const i=128,a="rgba(255,225,100,1)",r=this.makeTextTexture({width:i,height:i,fontSize:e,color:a,text:t});return r.context.strokeStyle=a,r.context.strokeRect(2,2,124,124),r.texture}makeBuyMap(){const t="rgba(255,205,75,1)",e=this.makeTextTexture({width:64,height:32,fontSize:12,color:t,text:"buy"});return e.context.strokeStyle=t,e.context.strokeRect(2,2,60,28),e.texture}makeMap4Item(t,e=""){return this.makeTextTexture({text:t,width:512,height:128,textAlign:"right",fontSize:28,fontY:128/3.5,fontFamily:"AvenirNext-UltraLight"})}setMap4Item(t,e="++++",i=""){const a=128;t.context.fillStyle="rgba(0, 0, 0, 1)",t.context.fillRect(0,0,512,a),t.context.strokeStyle="rgba(50, 50, 30, 1)",t.context.strokeRect(1,1,510,126),t.context.textAlign="left",t.context.strokeStyle="#FFdF60",t.context.fillStyle="#FFFFFF",t.context.font="18pt AvenirNext-UltraLight",t.context.strokeText(e,20,a/3),t.context.fillText(e,20,a/3),t.context.font="16pt AvenirNext-UltraLight";const r=i.split("\n");for(let e=0;e<r.length;e++)t.context.fillText(r[e],20,64+26*e+10);t.texture.needsUpdate=!0}}const n={unpackFloat:["vec3 float_to_vec3( float data ) {","vec3 uncompressed;","uncompressed.x = fract( data );","float zInt = floor( data / 255.0 );","uncompressed.z = fract( zInt / 255.0 );","uncompressed.y = fract( floor( data - ( zInt * 255.0 ) ) / 255.0 );","return uncompressed;","}"].join("\n"),computeVertexPositionVS:["vec2 texCoord = gl_FragCoord.xy / vec2( viewWidth, viewHeight );","vec4 normalDepth = texture2D( samplerNormalDepth, texCoord );","float z = normalDepth.w;","if ( z == 0.0 ) discard;","vec2 xy = texCoord * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, z, 1.0 );","vec4 vertexPositionVS = matProjInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeNormal:["vec3 normal = normalDepth.xyz * 2.0 - 1.0;"].join("\n"),unpackColorMap:["vec4 colorMap = texture2D( samplerColor, texCoord );","vec3 albedo = float_to_vec3( abs( colorMap.x ) );","vec3 specularColor = float_to_vec3( abs( colorMap.y ) );","float shininess = abs( colorMap.z );","float wrapAround = sign( colorMap.z );","float additiveSpecular = sign( colorMap.y );"].join("\n"),computeDiffuse:["float dotProduct = dot( normal, lightVector );","float diffuseFull = max( dotProduct, 0.0 );","vec3 diffuse;","if ( wrapAround < 0.0 ) {","float diffuseHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","const vec3 wrapRGB = vec3( 1.0, 1.0, 1.0 );","diffuse = mix( vec3( diffuseFull ), vec3( diffuseHalf ), wrapRGB );","} else {","diffuse = vec3( diffuseFull );","}"].join("\n"),computeSpecular:["vec3 halfVector = normalize( lightVector - normalize( vertexPositionVS.xyz ) );","float dotNormalHalf = max( dot( normal, halfVector ), 0.0 );","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specularColor + vec3( 1.0 - specularColor ) * pow( 1.0 - dot( lightVector, halfVector ), 5.0 );","vec3 specular = schlick * max( pow( dotNormalHalf, shininess ), 0.0 ) * diffuse * specularNormalization;"].join("\n"),combine:["vec3 light = lightIntensity * lightColor;","gl_FragColor = vec4( light * ( albedo * diffuse + specular ), attenuation );"].join("\n")},o={color:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.shadowmap,{emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},wrapAround:{type:"f",value:1},additiveSpecular:{type:"f",value:1},samplerNormalDepth:{type:"t",value:null},viewWidth:{type:"f",value:800},viewHeight:{type:"f",value:600}}]),fragmentShader:["uniform vec3 diffuse;","uniform vec3 specular;","uniform vec3 emissive;","uniform float shininess;","uniform float wrapAround;","uniform float additiveSpecular;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,"#ifdef USE_ENVMAP","varying vec3 vWorldPosition;","uniform float reflectivity;","uniform samplerCube envMap;","uniform float flipEnvMap;","uniform int combine;","uniform bool useRefract;","uniform float refractionRatio;","uniform sampler2D samplerNormalDepth;","uniform float viewHeight;","uniform float viewWidth;","#endif",THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"const float unit = 255.0/256.0;","float vec3_to_float( vec3 data ) {","highp float compressed = fract( data.x * unit ) + floor( data.y * unit * 255.0 ) + floor( data.z * unit * 255.0 ) * 255.0;","return compressed;","}","void main() {","const float opacity = 1.0;","gl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,"#ifdef USE_ENVMAP","vec2 texCoord = gl_FragCoord.xy / vec2( viewWidth, viewHeight );","vec4 normalDepth = texture2D( samplerNormalDepth, texCoord );","vec3 normal = normalDepth.xyz * 2.0 - 1.0;","vec3 reflectVec;","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","reflectVec = refract( cameraToVertex, normal, refractionRatio );","} else { ","reflectVec = reflect( cameraToVertex, normal );","}","#ifdef DOUBLE_SIDED","float flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );","vec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#else","vec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#endif","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif",THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.fog_fragment,"const float compressionScale = 0.999;","vec3 diffuseMapColor;","#ifdef USE_MAP","diffuseMapColor = texelColor.xyz;","#else","diffuseMapColor = vec3( 1.0 );","#endif","gl_FragColor.x = vec3_to_float( compressionScale * gl_FragColor.xyz );","if ( additiveSpecular < 0.0 ) {","gl_FragColor.y = vec3_to_float( compressionScale * specular );","} else {","gl_FragColor.y = vec3_to_float( compressionScale * specular * diffuseMapColor );","}","gl_FragColor.y *= additiveSpecular;","gl_FragColor.z = wrapAround * shininess;","#ifdef USE_COLOR","gl_FragColor.w = vec3_to_float( compressionScale * emissive * diffuseMapColor * vColor );","#else","gl_FragColor.w = vec3_to_float( compressionScale * emissive * diffuseMapColor );","#endif","}"].join("\n"),vertexShader:[THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"#ifdef USE_ENVMAP","varying vec3 vWorldPosition;","#endif","void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.shadowmap_vertex,"#ifdef USE_ENVMAP","vWorldPosition = worldPosition.xyz;","#endif","}"].join("\n")},normalDepth:{uniforms:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)}},fragmentShader:["#ifdef USE_BUMPMAP","#extension GL_OES_standard_derivatives : enable\n","varying vec2 vUv;","varying vec3 vViewPosition;",THREE.ShaderChunk.bumpmap_pars_fragment,"#endif","varying vec3 normalView;","varying vec4 clipPos;","void main() {","vec3 normal = normalize( normalView );","#ifdef USE_BUMPMAP","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","gl_FragColor.xyz = normal * 0.5 + 0.5;","gl_FragColor.w = clipPos.z / clipPos.w;","}"].join("\n"),vertexShader:["varying vec3 normalView;","varying vec4 clipPos;","#ifdef USE_BUMPMAP","varying vec2 vUv;","varying vec3 vViewPosition;","uniform vec4 offsetRepeat;","#endif",THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,"void main() {",THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,"normalView = normalize( normalMatrix * objectNormal );","#ifdef USE_BUMPMAP","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","vViewPosition = -mvPosition.xyz;","#endif","clipPos = gl_Position;","}"].join("\n")},composite:{uniforms:{samplerLight:{type:"t",value:null},brightness:{type:"f",value:1}},fragmentShader:["varying vec2 texCoord;","uniform sampler2D samplerLight;","uniform float brightness;","#ifdef TONEMAP_UNCHARTED","const float A = 0.15;","const float B = 0.50;","const float C = 0.10;","const float D = 0.20;","const float E = 0.02;","const float F = 0.30;","const float W = 11.2;","vec3 Uncharted2Tonemap( vec3 x ) {","return ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","}","#endif","void main() {","vec3 inColor = texture2D( samplerLight, texCoord ).xyz;","inColor *= brightness;","vec3 outColor;","#if defined( TONEMAP_SIMPLE )","outColor = sqrt( inColor );","#elif defined( TONEMAP_LINEAR )","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_REINHARD )","inColor = inColor / ( 1.0 + inColor );","outColor = pow( inColor, vec3( 1.0 / 2.2 ) );","#elif defined( TONEMAP_FILMIC )","vec3 x = max( vec3( 0.0 ), inColor - 0.004 );","outColor = ( x * ( 6.2 * x + 0.5 ) ) / ( x * ( 6.2 * x + 1.7 ) + 0.06 );","#elif defined( TONEMAP_UNCHARTED )","float ExposureBias = 2.0;","vec3 curr = Uncharted2Tonemap( ExposureBias * inColor );","vec3 whiteScale = vec3( 1.0 ) / Uncharted2Tonemap( vec3( W ) );","vec3 color = curr * whiteScale;","outColor = pow( color, vec3( 1.0 / 2.2 ) );","#else","outColor = inColor;","#endif","gl_FragColor = vec4( outColor, 1.0 );","}"].join("\n"),vertexShader:["varying vec2 texCoord;","void main() {","vec4 pos = vec4( sign( position.xy ), 0.0, 1.0 );","texCoord = pos.xy * vec2( 0.5 ) + 0.5;","gl_Position = pos;","}"].join("\n")},pointLight:{uniforms:{samplerNormalDepth:{type:"t",value:null},samplerColor:{type:"t",value:null},matProjInverse:{type:"m4",value:new THREE.Matrix4},viewWidth:{type:"f",value:800},viewHeight:{type:"f",value:600},lightPositionVS:{type:"v3",value:new THREE.Vector3(0,0,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},lightRadius:{type:"f",value:1}},fragmentShader:["uniform sampler2D samplerColor;","uniform sampler2D samplerNormalDepth;","uniform float lightRadius;","uniform float lightIntensity;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColor;","uniform vec3 lightPositionVS;","uniform mat4 matProjInverse;",n.unpackFloat,"void main() {",n.computeVertexPositionVS,"vec3 lightVector = lightPositionVS - vertexPositionVS.xyz;","float distance = length( lightVector );","if ( distance > lightRadius ) discard;",n.computeNormal,n.unpackColorMap,"lightVector = normalize( lightVector );",n.computeDiffuse,n.computeSpecular,"float cutoff = 0.3;","float denom = distance / lightRadius + 1.0;","float attenuation = 1.0 / ( denom * denom );","attenuation = ( attenuation - cutoff ) / ( 1.0 - cutoff );","attenuation = max( attenuation, 0.0 );","attenuation *= attenuation;",n.combine,"}"].join("\n"),vertexShader:["void main() { ","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n")},spotLight:{uniforms:{samplerNormalDepth:{type:"t",value:null},samplerColor:{type:"t",value:null},matProjInverse:{type:"m4",value:new THREE.Matrix4},viewWidth:{type:"f",value:800},viewHeight:{type:"f",value:600},lightPositionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightDirectionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},lightDistance:{type:"f",value:1},lightAngle:{type:"f",value:1}},fragmentShader:["uniform vec3 lightPositionVS;","uniform vec3 lightDirectionVS;","uniform sampler2D samplerColor;","uniform sampler2D samplerNormalDepth;","uniform float viewHeight;","uniform float viewWidth;","uniform float lightAngle;","uniform float lightIntensity;","uniform vec3 lightColor;","uniform mat4 matProjInverse;",n.unpackFloat,"void main() {",n.computeVertexPositionVS,n.computeNormal,n.unpackColorMap,"vec3 lightVector = normalize( lightPositionVS.xyz - vertexPositionVS.xyz );","float rho = dot( lightDirectionVS, lightVector );","float rhoMax = cos( lightAngle * 0.5 );","if ( rho <= rhoMax ) discard;","float theta = rhoMax + 0.0001;","float phi = rhoMax + 0.05;","float falloff = 4.0;","float spot = 0.0;","if ( rho >= phi ) {","spot = 1.0;","} else if ( rho <= theta ) {","spot = 0.0;","} else { ","spot = pow( ( rho - theta ) / ( phi - theta ), falloff );","}",n.computeDiffuse,"diffuse *= spot;",n.computeSpecular,"const float attenuation = 1.0;",n.combine,"}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},directionalLight:{uniforms:{samplerNormalDepth:{type:"t",value:null},samplerColor:{type:"t",value:null},matProjInverse:{type:"m4",value:new THREE.Matrix4},viewWidth:{type:"f",value:800},viewHeight:{type:"f",value:600},lightDirectionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1}},fragmentShader:["uniform sampler2D samplerColor;","uniform sampler2D samplerNormalDepth;","uniform float lightRadius;","uniform float lightIntensity;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColor;","uniform vec3 lightDirectionVS;","uniform mat4 matProjInverse;",n.unpackFloat,"void main() {",n.computeVertexPositionVS,n.computeNormal,n.unpackColorMap,"vec3 lightVector = lightDirectionVS;",n.computeDiffuse,n.computeSpecular,"const float attenuation = 1.0;",n.combine,"}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},hemisphereLight:{uniforms:{samplerNormalDepth:{type:"t",value:null},samplerColor:{type:"t",value:null},matProjInverse:{type:"m4",value:new THREE.Matrix4},viewWidth:{type:"f",value:800},viewHeight:{type:"f",value:600},lightDirectionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightColorSky:{type:"c",value:new THREE.Color(0)},lightColorGround:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1}},fragmentShader:["uniform sampler2D samplerColor;","uniform sampler2D samplerNormalDepth;","uniform float lightRadius;","uniform float lightIntensity;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColorSky;","uniform vec3 lightColorGround;","uniform vec3 lightDirectionVS;","uniform mat4 matProjInverse;",n.unpackFloat,"void main() {",n.computeVertexPositionVS,n.computeNormal,n.unpackColorMap,"vec3 lightVector = lightDirectionVS;","float dotProduct = dot( normal, lightVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( lightColorGround, lightColorSky, hemiDiffuseWeight );","vec3 diffuse = hemiColor;","vec3 hemiHalfVectorSky = normalize( lightVector - vertexPositionVS.xyz );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );","vec3 lVectorGround = -lightVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround - vertexPositionVS.xyz );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlickSky = specularColor + vec3( 1.0 - specularColor ) * pow( 1.0 - dot( lightVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = specularColor + vec3( 1.0 - specularColor ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","vec3 specular = hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","gl_FragColor = vec4( lightIntensity * ( albedo * diffuse + specular ), 1.0 );","}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},areaLight:{uniforms:{samplerNormalDepth:{type:"t",value:null},samplerColor:{type:"t",value:null},matProjInverse:{type:"m4",value:new THREE.Matrix4},viewWidth:{type:"f",value:800},viewHeight:{type:"f",value:600},lightPositionVS:{type:"v3",value:new THREE.Vector3(0,1,0)},lightNormalVS:{type:"v3",value:new THREE.Vector3(0,-1,0)},lightRightVS:{type:"v3",value:new THREE.Vector3(1,0,0)},lightUpVS:{type:"v3",value:new THREE.Vector3(1,0,0)},lightColor:{type:"c",value:new THREE.Color(0)},lightIntensity:{type:"f",value:1},lightWidth:{type:"f",value:1},lightHeight:{type:"f",value:1},constantAttenuation:{type:"f",value:1.5},linearAttenuation:{type:"f",value:.5},quadraticAttenuation:{type:"f",value:.1}},fragmentShader:["uniform vec3 lightPositionVS;","uniform vec3 lightNormalVS;","uniform vec3 lightRightVS;","uniform vec3 lightUpVS;","uniform sampler2D samplerColor;","uniform sampler2D samplerNormalDepth;","uniform float lightWidth;","uniform float lightHeight;","uniform float constantAttenuation;","uniform float linearAttenuation;","uniform float quadraticAttenuation;","uniform float lightIntensity;","uniform vec3 lightColor;","uniform float viewHeight;","uniform float viewWidth;","uniform mat4 matProjInverse;",n.unpackFloat,"vec3 projectOnPlane( vec3 point, vec3 planeCenter, vec3 planeNorm ) {","return point - dot( point - planeCenter, planeNorm ) * planeNorm;","}","bool sideOfPlane( vec3 point, vec3 planeCenter, vec3 planeNorm ) {","return ( dot( point - planeCenter, planeNorm ) >= 0.0 );","}","vec3 linePlaneIntersect( vec3 lp, vec3 lv, vec3 pc, vec3 pn ) {","return lp + lv * ( dot( pn, pc - lp ) / dot( pn, lv ) );","}","float calculateAttenuation( float dist ) {","return ( 1.0 / ( constantAttenuation + linearAttenuation * dist + quadraticAttenuation * dist * dist ) );","}","void main() {",n.computeVertexPositionVS,n.computeNormal,n.unpackColorMap,"float w = lightWidth;","float h = lightHeight;","vec3 proj = projectOnPlane( vertexPositionVS.xyz, lightPositionVS, lightNormalVS );","vec3 dir = proj - lightPositionVS;","vec2 diagonal = vec2( dot( dir, lightRightVS ), dot( dir, lightUpVS ) );","vec2 nearest2D = vec2( clamp( diagonal.x, -w, w ), clamp( diagonal.y, -h, h ) );","vec3 nearestPointInside = vec3( lightPositionVS ) + ( lightRightVS * nearest2D.x + lightUpVS * nearest2D.y );","vec3 lightDir = normalize( nearestPointInside - vertexPositionVS.xyz );","float NdotL = max( dot( lightNormalVS, -lightDir ), 0.0 );","float NdotL2 = max( dot( normal, lightDir ), 0.0 );","if ( NdotL2 * NdotL > 0.0 ) {","vec3 diffuse = vec3( sqrt( NdotL * NdotL2 ) );","vec3 specular = vec3( 0.0 );","vec3 R = reflect( normalize( -vertexPositionVS.xyz ), normal );","vec3 E = linePlaneIntersect( vertexPositionVS.xyz, R, vec3( lightPositionVS ), lightNormalVS );","float specAngle = dot( R, lightNormalVS );","if ( specAngle > 0.0 ) {","vec3 dirSpec = E - vec3( lightPositionVS );","vec2 dirSpec2D = vec2( dot( dirSpec, lightRightVS ), dot( dirSpec, lightUpVS ) );","vec2 nearestSpec2D = vec2( clamp( dirSpec2D.x, -w, w ), clamp( dirSpec2D.y, -h, h ) );","float specFactor = 1.0 - clamp( length( nearestSpec2D - dirSpec2D ) * 0.05 * shininess, 0.0, 1.0 );","specular = specularColor * specFactor * specAngle * diffuse;","}","float dist = distance( vertexPositionVS.xyz, nearestPointInside );","float attenuation = calculateAttenuation( dist );",n.combine,"} else {","discard;","}","}"].join("\n"),vertexShader:["void main() {","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")},emissiveLight:{uniforms:{samplerColor:{type:"t",value:null},viewWidth:{type:"f",value:800},viewHeight:{type:"f",value:600}},fragmentShader:["uniform sampler2D samplerColor;","uniform float viewHeight;","uniform float viewWidth;",n.unpackFloat,"void main() {","vec2 texCoord = gl_FragCoord.xy / vec2( viewWidth, viewHeight );","vec4 colorMap = texture2D( samplerColor, texCoord );","vec3 emissiveColor = float_to_vec3( abs( colorMap.w ) );","gl_FragColor = vec4( emissiveColor, 1.0 );","}"].join("\n"),vertexShader:["void main() { ","gl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n")}},s=function(t){var e=this,i=void 0!==t.width?t.width:800,a=void 0!==t.height?t.height:600,r=void 0!==t.scale?t.scale:1,n=Math.floor(r*i),s=Math.floor(r*a),h=void 0!==t.brightness?t.brightness:1,l=void 0!==t.tonemapping?t.tonemapping:THREE.SimpleOperator,c=void 0!==t.antialias&&t.antialias;this.renderer=t.renderer,void 0===this.renderer&&(this.renderer=new THREE.WebGLRenderer({antialias:!1}),this.renderer.setSize(i,a),this.renderer.setClearColor(0,0),this.renderer.autoClear=!1),this.domElement=this.renderer.domElement,this.setViewport=function(t,e,i,a){this.renderer.setViewport(t,e,i,a)},this.clear=function(){},this.clearDepth=function(){};var m,d,u,p,f,g,v,y=this.renderer.getContext(),x=null,w=new THREE.Matrix4,_=new THREE.Vector3,E=new THREE.Vector3,b=new THREE.Vector3,S=new THREE.Vector3,T=new THREE.Vector3,C=new THREE.Vector3,R=new THREE.SphereGeometry(1,16,8),P=new THREE.PlaneGeometry(2,2),M=new THREE.Color(0),A=o.color,H=o.normalDepth,V=o.emissiveLight,D=o.pointLight,z=o.spotLight,k=o.directionalLight,I=o.hemisphereLight,U=o.areaLight,B=o.composite;let O,W;var j,F,L,N=[],G=new THREE.ShaderMaterial;G.visible=!1;var q=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(H.uniforms),vertexShader:H.vertexShader,fragmentShader:H.fragmentShader,blending:THREE.NoBlending}),Q=function(t){var e={},i=THREE.UniformsUtils.clone(A.uniforms),a={USE_MAP:!!t.map,USE_ENVMAP:!!t.envMap,GAMMA_INPUT:!0},r=new THREE.ShaderMaterial({fragmentShader:A.fragmentShader,vertexShader:A.vertexShader,uniforms:i,defines:a,shading:t.shading});if(t instanceof THREE.MeshBasicMaterial)var o=M,h=t.color;else o=t.color,h=void 0!==t.emissive?t.emissive:M;var l,c=void 0!==t.specular?t.specular:M,m=void 0!==t.shininess?t.shininess:1,d=void 0!==t.wrapAround&&t.wrapAround?-1:1,u=void 0!==t.metal&&t.metal?1:-1;if(i.emissive.value.copyGammaToLinear(h),i.diffuse.value.copyGammaToLinear(o),i.specular.value.copyGammaToLinear(c),i.shininess.value=m,i.wrapAround.value=d,i.additiveSpecular.value=u,i.map.value=t.map,t.envMap&&(i.envMap.value=t.envMap,i.useRefract.value=t.envMap.mapping instanceof THREE.CubeRefractionMapping,i.refractionRatio.value=t.refractionRatio,i.combine.value=t.combine,i.reflectivity.value=t.reflectivity,i.flipEnvMap.value=t.envMap instanceof THREE.WebGLRenderTargetCube?1:-1,i.samplerNormalDepth.value=W.renderTarget2,i.viewWidth.value=n,i.viewHeight.value=s,N.push({material:r})),r.vertexColors=t.vertexColors,r.morphTargets=t.morphTargets,r.morphNormals=t.morphNormals,r.skinning=t.skinning,r.alphaTest=t.alphaTest,r.wireframe=t.wireframe,t.map?l=t.map:t.specularMap?l=t.specularMap:t.normalMap?l=t.normalMap:t.bumpMap&&(l=t.bumpMap),void 0!==l){var p=l.offset,f=l.repeat;i.offsetRepeat.value.set(p.x,p.y,f.x,f.y)}if(e.colorMaterial=r,t.morphTargets||t.skinning||t.bumpMap){i=THREE.UniformsUtils.clone(H.uniforms),a={USE_BUMPMAP:!!t.bumpMap};if((g=new THREE.ShaderMaterial({uniforms:i,vertexShader:H.vertexShader,fragmentShader:H.fragmentShader,shading:t.shading,defines:a,blending:THREE.NoBlending})).morphTargets=t.morphTargets,g.morphNormals=t.morphNormals,g.skinning=t.skinning,t.bumpMap){i.bumpMap.value=t.bumpMap,i.bumpScale.value=t.bumpScale;p=t.bumpMap.offset,f=t.bumpMap.repeat;i.offsetRepeat.value.set(p.x,p.y,f.x,f.y)}}else var g=q.clone();return g.wireframe=t.wireframe,g.vertexColors=t.vertexColors,e.normalDepthMaterial=g,e.transparent=t.transparent,e},Y=function(t){var e=t.userData.originalLight,i=t.material.uniforms,a=e.distance;a>0?(t.scale.set(1,1,1).multiplyScalar(a),i.lightRadius.value=a,_.setFromMatrixPosition(e.matrixWorld),_.applyMatrix4(x.matrixWorldInverse),i.lightPositionVS.value.copy(_),t.position.setFromMatrixPosition(e.matrixWorld)):i.lightRadius.value=1/0;var r=e.intensity*e.intensity;i.lightIntensity.value=r,i.lightColor.value.copyGammaToLinear(e.color)},K=function(t){var e=t.userData.originalLight,i=t.material.uniforms,a=x.matrixWorldInverse,r=e.matrixWorld;_.setFromMatrixPosition(r),_.applyMatrix4(a),E.setFromMatrixPosition(r),b.setFromMatrixPosition(e.target.matrixWorld),E.sub(b),E.normalize(),E.transformDirection(a),i.lightPositionVS.value.copy(_),i.lightDirectionVS.value.copy(E),i.lightAngle.value=e.angle,i.lightDistance.value=e.distance;var n=e.intensity*e.intensity;i.lightIntensity.value=n,i.lightColor.value.copyGammaToLinear(e.color)},Z=function(t){var e=t.userData.originalLight,i=t.material.uniforms;E.setFromMatrixPosition(e.matrixWorld),b.setFromMatrixPosition(e.target.matrixWorld),E.sub(b),E.normalize(),E.transformDirection(x.matrixWorldInverse),i.lightDirectionVS.value.copy(E);var a=e.intensity*e.intensity;i.lightIntensity.value=a,i.lightColor.value.copyGammaToLinear(e.color)},X=function(t){var e=t.userData.originalLight,i=t.material.uniforms;E.setFromMatrixPosition(e.matrixWorld),E.normalize(),E.transformDirection(x.matrixWorldInverse),i.lightDirectionVS.value.copy(E);var a=e.intensity*e.intensity;i.lightIntensity.value=a,i.lightColorSky.value.copyGammaToLinear(e.color),i.lightColorGround.value.copyGammaToLinear(e.groundColor)},$=function(t){var e=t.userData.originalLight,i=t.material.uniforms,a=e.matrixWorld,r=x.matrixWorldInverse;_.setFromMatrixPosition(a),_.applyMatrix4(r),i.lightPositionVS.value.copy(_),S.copy(e.right),S.transformDirection(a),S.transformDirection(r),T.copy(e.normal),T.transformDirection(a),T.transformDirection(r),C.crossVectors(S,T),C.normalize(),i.lightRightVS.value.copy(S),i.lightNormalVS.value.copy(T),i.lightUpVS.value.copy(C),i.lightWidth.value=e.width||1,i.lightHeight.value=e.height||1,i.constantAttenuation.value=e.constantAttenuation,i.linearAttenuation.value=e.linearAttenuation,i.quadraticAttenuation.value=e.quadraticAttenuation;var n=e.intensity*e.intensity;i.lightIntensity.value=n,i.lightColor.value.copyGammaToLinear(e.color)},J=function(t){if(!t.userData.deferredInitialized){if(t.material&&function(t){if(t.material instanceof THREE.MeshFaceMaterial){for(var e=[],i=[],a=t.material.materials,r=0,n=a.length;r<n;r++)(o=Q(a[r])).transparent?(e.push(G),i.push(G)):(e.push(o.colorMaterial),i.push(o.normalDepthMaterial));t.userData.colorMaterial=new THREE.MeshFaceMaterial(e),t.userData.normalDepthMaterial=new THREE.MeshFaceMaterial(i)}else{var o=Q(t.material);t.userData.colorMaterial=o.colorMaterial,t.userData.normalDepthMaterial=o.normalDepthMaterial,t.userData.transparent=o.transparent}}(t),t instanceof THREE.PointLight){var e=function(t){var e,i=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(D.uniforms),vertexShader:D.vertexShader,fragmentShader:D.fragmentShader,blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0,side:THREE.BackSide});t.distance>0?e=R:(e=P,i.depthTest=!1,i.side=THREE.FrontSide),i.uniforms.viewWidth.value=n,i.uniforms.viewHeight.value=s,i.uniforms.samplerColor.value=m.renderTarget2,i.uniforms.samplerNormalDepth.value=W.renderTarget2;var a=new THREE.Mesh(e,i);return a.userData.originalLight=t,N.push({material:i}),Y(a),a}(t);t.distance>0?L.add(e):F.add(e)}else if(t instanceof THREE.SpotLight){e=function(t){var e=THREE.UniformsUtils.clone(z.uniforms),i=new THREE.ShaderMaterial({uniforms:e,vertexShader:z.vertexShader,fragmentShader:z.fragmentShader,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});e.viewWidth.value=n,e.viewHeight.value=s,e.samplerColor.value=m.renderTarget2,e.samplerNormalDepth.value=W.renderTarget2;var a=new THREE.Mesh(P,i);return a.userData.originalLight=t,N.push({material:i}),K(a),a}(t);F.add(e)}else if(t instanceof THREE.DirectionalLight){e=function(t){var e=THREE.UniformsUtils.clone(k.uniforms),i=new THREE.ShaderMaterial({uniforms:e,vertexShader:k.vertexShader,fragmentShader:k.fragmentShader,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});e.viewWidth.value=n,e.viewHeight.value=s,e.samplerColor.value=m.renderTarget2,e.samplerNormalDepth.value=W.renderTarget2;var a=new THREE.Mesh(P,i);return a.userData.originalLight=t,N.push({material:i}),Z(a),a}(t);F.add(e)}else if(t instanceof THREE.HemisphereLight){e=function(t){var e=THREE.UniformsUtils.clone(I.uniforms),i=new THREE.ShaderMaterial({uniforms:e,vertexShader:I.vertexShader,fragmentShader:I.fragmentShader,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});e.viewWidth.value=n,e.viewHeight.value=s,e.samplerColor.value=m.renderTarget2,e.samplerNormalDepth.value=W.renderTarget2;var a=new THREE.Mesh(P,i);return a.userData.originalLight=t,N.push({material:i}),X(a),a}(t);F.add(e)}else if(t instanceof THREE.RectAreaLight){e=function(t){var e=THREE.UniformsUtils.clone(U.uniforms),i=new THREE.ShaderMaterial({uniforms:e,vertexShader:U.vertexShader,fragmentShader:U.fragmentShader,blending:THREE.AdditiveBlending,depthWrite:!1,depthTest:!1,transparent:!0});e.viewWidth.value=n,e.viewHeight.value=s,e.samplerColor.value=m.renderTarget2,e.samplerNormalDepth.value=W.renderTarget2;var a=new THREE.Mesh(P,i);return a.userData.originalLight=t,N.push({material:i}),$(a),a}(t);F.add(e)}t.userData.deferredInitialized=!0}},tt=function(t){t.material&&(t.userData.transparent?t.material=G:t.material=t.userData.colorMaterial)},et=function(t){t.material&&(t.userData.transparent?t.material=G:t.material=t.userData.normalDepthMaterial)};function it(t){var e=t.material.uniforms;e.matProjInverse&&(e.matProjInverse.value=w),e.matView&&(e.matView.value=x.matrixWorldInverse);var i=t.userData.originalLight;i&&(t.visible=i.visible,i instanceof THREE.PointLight?Y(t):i instanceof THREE.SpotLight?K(t):i instanceof THREE.DirectionalLight?Z(t):i instanceof THREE.HemisphereLight?X(t):i instanceof THREE.AreaLight&&$(t))}this.setAntialias=function(t){(c=t)?(j.enabled=!0,v.renderToScreen=!1):(j.enabled=!1,v.renderToScreen=!0)},this.getAntialias=function(){return c},this.addEffect=function(t,e,i){t.material&&t.uniforms&&(e&&(t.uniforms[e].value=W.renderTarget2),i&&(t.uniforms[i].value=m.renderTarget2),(e||i)&&N.push({material:t.material,normalDepth:e,color:i})),u.insertPass(t,-1)},this.setScale=function(t){r=t,n=Math.floor(r*i),s=Math.floor(r*a),W.setSize(n,s),m.setSize(n,s),d.setSize(n,s),u.setSize(n,s),m.renderTarget2.shareDepthFrom=W.renderTarget2,d.renderTarget2.shareDepthFrom=W.renderTarget2;for(var e=0,o=N.length;e<o;e++){var h=N[e],l=h.material.uniforms,c=void 0!==h.color?h.color:"samplerColor",p=void 0!==h.normalDepth?h.normalDepth:"samplerNormalDepth";l[c]&&(l[c].value=m.renderTarget2),l[p]&&(l[p].value=W.renderTarget2),l.viewWidth&&(l.viewWidth.value=n),l.viewHeight&&(l.viewHeight.value=s)}v.uniforms.samplerLight.value=d.renderTarget2},this.setSize=function(t,e){i=t,a=e,this.renderer.setSize(i,a),this.setScale(r)},this.render=function(t,e){if(!t.userData.lightSceneProxy){t.userData.lightSceneProxy=new THREE.Scene,t.userData.lightSceneFullscreen=new THREE.Scene;var i=function(){var t=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(V.uniforms),vertexShader:V.vertexShader,fragmentShader:V.fragmentShader,depthTest:!1,depthWrite:!1,blending:THREE.NoBlending});t.uniforms.viewWidth.value=n,t.uniforms.viewHeight.value=s,t.uniforms.samplerColor.value=m.renderTarget2;var e=new THREE.Mesh(P,t);return N.push({material:t}),e}();t.userData.lightSceneFullscreen.add(i)}x=e,L=t.userData.lightSceneProxy,F=t.userData.lightSceneFullscreen,p.camera=x,O.camera=x,g.camera=x,f.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),p.scene=t,O.scene=t,f.scene=F,g.scene=L,t.traverse(J),t.autoUpdate=!1,t.updateMatrixWorld(),t.traverse(et),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,y.stencilOp(y.REPLACE,y.REPLACE,y.REPLACE),y.stencilFunc(y.ALWAYS,1,4294967295),y.clearStencil(0),W.render(),y.stencilFunc(y.EQUAL,1,4294967295),y.stencilOp(y.KEEP,y.KEEP,y.KEEP),t.traverse(tt),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!1,m.render(),this.renderer.autoClearDepth=!1,t.autoUpdate=!0,y.depthFunc(y.GEQUAL),w.copy(x.projectionMatrix).invert();for(var a=0,r=L.children.length;a<r;a++){it(L.children[a])}for(a=0,r=F.children.length;a<r;a++){it(F.children[a])}d.render(),this.renderer.autoClearDepth=!0,this.renderer.autoClearStencil=!0,y.depthFunc(y.LEQUAL),y.disable(y.STENCIL_TEST),u.render(.1)};!function(){var t,i={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!0,format:THREE.RGBAFormat,type:THREE.FloatType},a={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,stencilBuffer:!0,format:THREE.RGBAFormat,type:THREE.FloatType},r={minFilter:THREE.NearestFilter,magFilter:THREE.LinearFilter,stencilBuffer:!1,format:THREE.RGBFormat,type:THREE.UnsignedByteType},o=new THREE.WebGLRenderTarget(n,s,a),y=new THREE.WebGLRenderTarget(n,s,a),x=new THREE.WebGLRenderTarget(n,s,i),w=new THREE.WebGLRenderTarget(n,s,r);switch(o.texture.generateMipmaps=!1,y.texture.generateMipmaps=!1,x.texture.generateMipmaps=!1,w.texture.generateMipmaps=!1,O=new THREE.RenderPass,O.clear=!0,W=new THREE.EffectComposer(e.renderer,y),W.addPass(O),(p=new THREE.RenderPass).clear=!0,(m=new THREE.EffectComposer(e.renderer,o)).addPass(p),m.renderTarget2.shareDepthFrom=W.renderTarget2,(f=new THREE.RenderPass).clear=!0,(g=new THREE.RenderPass).clear=!1,(d=new THREE.EffectComposer(e.renderer,x)).addPass(f),d.addPass(g),d.renderTarget2.shareDepthFrom=W.renderTarget2,(v=new THREE.ShaderPass(B)).uniforms.samplerLight.value=d.renderTarget2,v.uniforms.brightness.value=h,v.material.blending=THREE.NoBlending,v.clear=!0,l){case THREE.SimpleOperator:t={TONEMAP_SIMPLE:!0};break;case THREE.LinearOperator:t={TONEMAP_LINEAR:!0};break;case THREE.ReinhardOperator:t={TONEMAP_REINHARD:!0};break;case THREE.FilmicOperator:t={TONEMAP_FILMIC:!0};break;case THREE.UnchartedOperator:t={TONEMAP_UNCHARTED:!0}}v.material.defines=t,(j=new THREE.ShaderPass(THREE.FXAAShader)).renderToScreen=!0,(u=new THREE.EffectComposer(e.renderer,w)).addPass(v),u.addPass(j),c?(j.enabled=!0,v.renderToScreen=!1):(j.enabled=!1,v.renderToScreen=!0)}()};class h{constructor(t){this._parent=t,this._id=null}set time(t){this._parent._slowVal=.5,this._id=DB.delayRun((()=>{this._parent._slowVal=1}),t,this._id)}}class l{constructor(){this.isStop=!1,this._id=null}set time(t){this.isStop=!0,this._id=DB.delayRun((()=>{this.isStop=!1}),t,this._id)}}let c,m,d,u,p,f,g,v,y,x,w,_,E=0;class b{constructor(t={}){t.setting||(t.setting={}),this._opt={background:0,fogColor:4206704},this._opt={...this._opt,...t},this.isControlOn=!1,this.isStop=!1,this.composer=null,this.uiScene=null,this.stop=new l,this.container=t.dom,this.controls=null,this.camera=null,this.scene=null,this.renderer=null,this.delta=null,this.aniArr=[],this.fixUpdateFuncs=[],this.animatEndFunc=[],this.slowUpdateFuncs=new Set,this.time=0,this.fixRate=1e3/15,this._uRate=null,this._fixUpdateTime=0,this.fogColor=this._opt.fogColor,this._clock=new THREE.Clock,this.w=globalThis.innerWidth,this.h=globalThis.innerHeight,this._startHTML(),this._setWidthHeight(),this.init(),this.isControlOn&&this._addControls(),this._slowVal=1,this._i=null,this.slow=new h(this),this.animate()}get info(){return this.renderer.renderer.info}get count(){return{mesh:DB.scene.scene.children.length,update:this.aniArr.length,fixUpdate:this.fixUpdateFuncs.length}}_startHTML(){globalThis.onError=function(t){},globalThis.addEventListener("resize",this.onWindowResize.bind(this),!1)}_setWidthHeight(){this.container&&(this.w=this.container.clientWidth,this.h=this.container.clientHeight||window.innerHeight)}init(){let t={};if(this._opt.setting.HighResolution?t.antialias=!1:t.antialias=!0,this._opt.canvas&&(t.canvas=this._opt.canvas),this._opt.useDeferred){t={...t,width:this.w,height:this.h,scale:1,antialias:!0,tonemapping:THREE.CineonToneMapping,brightness:2.5};const e=new s(t);this.renderer=e}else this._normalRender(t);this.container&&this.container.appendChild(this.renderer.domElement),this.camera=new THREE.PerspectiveCamera(45,this.w/this.h,.01,1500),this.scene=new THREE.Scene,this.scene.background=new THREE.Color(this._opt.background),this.scene.fog=new THREE.FogExp2(this.fogColor,.003)}_normalRender(t){this.renderer=new THREE.WebGLRenderer(t),this.renderer.setSize(this.w,this.h),this.renderer.setViewport(0,0,this.w,this.h),this.renderer.localClippingEnabled=!0,this.renderer.toneMapping=THREE.ACESFilmicToneMapping,this.renderer.outputEncoding=THREE.sRGBEncoding,this.renderer.shadowMap.enabled=!0,"low"===this._opt.setting.Shadow?this.renderer.shadowMap.type=THREE.BasicShadowMap:"mid"===this._opt.setting.Shadow?this.renderer.shadowMap.type=THREE.PCFShadowMap:"high"===this._opt.setting.Shadow&&(this.renderer.shadowMap.type=THREE.PCFSoftShadowMap),this.renderer.autoClear=!1}onWindowResize(){this._setWidthHeight(),this.camera.aspect=this.w/this.h,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.w,this.h),this.composer&&this.composer.setSize(this.w,this.h),this.uiScene&&this.uiScene.onWindowResize()}_addControls(){this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.update()}animate(){requestAnimationFrame((()=>{this.animate()})),this._update()}_update(){if(this.delta=this._clock.getDelta(),this.fixDelta=1-Math.pow(.001,this.delta),!this.isStop){if(this.fixAnimate(),!this.stop.isStop)for(this._i=0;this._i<this.aniArr.length;this._i++)this.aniArr[this._i](this.delta*this._slowVal,this.fixDelta);for(this.renderer.clear(),this.composer?this.composer.render():this.renderer.render(this.scene,this.camera),this.renderer.clearDepth(),this._i=0;this._i<this.animatEndFunc.length;this._i++)this.animatEndFunc[this._i](this.delta);this.time=Date.now()}}fixAnimate(){if(this._uRate=this.time-this._fixUpdateTime,!(this._uRate<this.fixRate/Math.min(2*this._slowVal,1))){for(this._fixUpdateTime=this.time-this.delta,this._i=0;this._i<this.fixUpdateFuncs.length;this._i++)this.fixUpdateFuncs[this._i]();this._slowAnimate()}}_slowAnimate(){if(E>0)return E-=1;for(c of(E=6,this.slowUpdateFuncs.values()))c()}addSlowUpdate(t){this.slowUpdateFuncs.add(t)}removeSlowUpdate(t){this.slowUpdateFuncs.delete(t)}remove(t){this.scene.remove(t)}erase(t){this.remove(t),t.geometry&&t.geometry.dispose(),t.material&&(t.material.map&&t.material.map.dispose(),t.material.dispose()),t.traverse((t=>{t.isMesh&&(this.remove(t),t.geometry&&t.geometry.dispose(),t.material&&(t.material.map&&t.material.map.dispose(),t.material.dispose()))}))}add(t){this.scene.add(t)}addFixUpdate(t){if(!(this.fixUpdateFuncs.indexOf(t)>=0))return this.fixUpdateFuncs.push(t),this}addUpdate(t){if(!(this.aniArr.indexOf(t)>=0))return this.aniArr.push(t),this}addEndUpdate(t){this.animatEndFunc.push(t)}removeFixUpdate(t){const e=this.fixUpdateFuncs.indexOf(t);if(!(e<0))return this.fixUpdateFuncs.splice(e,1),this}removeUpdate(t){const e=this.aniArr.indexOf(t);e<0||this.aniArr.splice(e,1)}setFogColor(t=this.fogColor){this.scene.fog.color.setHex(t)}removeAllChildren(){for(var t=this.scene.children.length-1;t>=0;t--){const e=this.scene.children[t];this.scene.remove(e)}}}class S{constructor(t){const{gravity:e=98}=t;this.gravityConstant=e,this.dispatcher=null,this.broadphase=null,this.solver=null,this.physicsWorld=null,this.margin=.05,this.meshObj={},this.staticBodies=[],this.debrisBodies=[],this.tinyDebris=[]}}class T{constructor(t){this._parent=t,this._data=t.data,this.transform=new Ammo.btTransform,this._t=new Ammo.btVector3,this._q=new Ammo.btQuaternion,this.transformAux1=new Ammo.btTransform}remove(t,e){this._data.physicsWorld.removeRigidBody(e),t.userData={},delete this._data.meshObj[t.uuid]}addBodyWithMesh(t,e,i,a,r,n,o){a?t.position.set(a.x,a.y,a.z):a=t.position,r?t.quaternion.set(r.x,r.y,r.z,r.w):r=t.quaternion,i=i||0;const s=this.addBody(e,i,a,r,n,o);t.userData.physicsBody=s,t.userData.collided=!1,this._data.meshObj[t.uuid]=t;const h=new Ammo.btVector3(0,0,0);return h.threeObject=t,s.setUserPointer(h),s}addBody(t,e,i={x:0,y:0,z:0},a={x:0,y:0,z:0,w:1},r=null,n=null){this.transform.setIdentity(),this._t.setValue(i.x,i.y,i.z),this._q.setValue(a.x,a.y,a.z,a.w),this.transform.setOrigin(this._t),this.transform.setRotation(this._q);const o=new Ammo.btDefaultMotionState(this.transform),s=this._t.setValue(0,0,0);t.calculateLocalInertia(e,s);const h=new Ammo.btRigidBodyConstructionInfo(e,o,t,s),l=new Ammo.btRigidBody(h);return l.setFriction(.6),r&&l.setLinearVelocity(this._t.setValue(r.x,r.y,r.z)),n&&l.setAngularVelocity(this._t.setValue(n.x,n.y,n.z)),e>0&&l.setActivationState(4),this._data.physicsWorld.addRigidBody(l),l}update(){for(m in this._data.meshObj)d=this._data.meshObj[m],p=d.userData,u=p.physicsBody,p.isStatic||(f=u.getMotionState(),f&&(f.getWorldTransform(this.transformAux1),g=this.transformAux1.getOrigin(),v=this.transformAux1.getRotation(),d.position.set(g.x(),g.y(),g.z()),d.quaternion.set(v.x(),v.y(),v.z(),v.w()),p.collided=!1))}createBody(t){const e=this.addBodyWithMesh(t.object,t.physicsShape,t.mass);return DB.scene.add(t.object),e}createCustom(t,e=0,i=!0){const a=t.geometry.attributes.position.array,r=this._parent.collider._createConvexHullPhysicsShape(a);r.setMargin(this._data.margin),t.castShadow=!0,t.receiveShadow=!0,i&&DB.scene.add(t);return this.addBodyWithMesh(t,r,e)}}class C{constructor(t){this._data=t.data,this._parent=t,this.transform=new Ammo.btTransform,this._BtVec3=new Ammo.btVector3,this._btQuat=new Ammo.btQuaternion,this._tEu=new THREE.Euler,this._tQu=new THREE.Quaternion,this._tv=new THREE.Vector3}getMesh(t){return Ammo.castObject(t.getUserPointer(),Ammo.btVector3).threeObject}setPosQuat(t,e,i){this._BtVec3.setValue(e.x||0,e.y||0,e.z||0),this._btQuat.setValue(i.x||0,i.y||0,i.z||0,i.w||1),this.transform.setIdentity(),this.transform.setRotation(this._btQuat),this.transform.setOrigin(this._BtVec3),t.setWorldTransform(this.transform),t.getMotionState&&t.getMotionState().setWorldTransform(this.transform)}setRotation(t,e={}){this._tEu.set(e.x||0,e.y||0,e.z||0),this._tQu.setFromEuler(this._tEu),this.setQuaternion(t,this._tQu)}setQuaternion(t,e){this._btQuat.setValue(e.x||0,e.y||0,e.z||0,e.w||0),this.transform.setIdentity(),this.transform.setRotation(this._btQuat),t.setWorldTransform(this.transform)}getPosition(t){const e=t.getWorldTransform().getOrigin();return{x:e.x(),y:e.y(),z:e.z()}}getQuaternion(t){const e=t.getWorldTransform().getRotation();return{x:e.x(),y:e.y(),z:e.z(),w:e.w()}}setPosition(t,e){this._BtVec3.setValue(e.x||0,e.y||0,e.z||0),this.transform.setIdentity(),this.transform.setOrigin(this._BtVec3),t.setWorldTransform(this.transform)}setPosition2(t,e){const i=t.getWorldTransform().getOrigin();this._BtVec3.setValue(i.x()+(e.x||0),i.y()+(e.y||0),i.z()+(e.z||0)),this.transform.setIdentity(),this.transform.setOrigin(this._BtVec3),t.setWorldTransform(this.transform)}setVelocity(t,e={}){this._BtVec3.setValue(e.x||0,e.y||0,e.z||0),t.setLinearVelocity&&t.setLinearVelocity(this._BtVec3)}_sameObj(t,e,i,a){const r=new THREE.Mesh(e,i);return r.userData.getSelf=()=>t,a&&(r.name=a),t.position&&r.position.set(t.position.x,t.position.y,t.position.z),r}_samePhy(t,e,i){i.setMargin(this._data.margin);const a={object:e,physicsShape:i,mass:t.mass,pos:t.position,quat:t.quaternion};this._parent.basic.createBody(a)}createBox(t,e,i){const a=new THREE.BoxBufferGeometry(t.size.x,t.size.y,t.size.z,1,1,1),r=this._sameObj(t,a,e,i);this._BtVec3.setValue(.5*t.size.x,.5*t.size.y,.5*t.size.z);const n=new Ammo.btBoxShape(this._BtVec3);return this._samePhy(t,r,n),r}createCylinder(t,e,i){const a=new THREE.CylinderBufferGeometry(t.size.top,t.size.bottom,t.size.height,16,1),r=this._sameObj(t,a,e,i);this._BtVec3.setValue(t.size.top,.5*t.size.height,t.size.bottom);const n=new Ammo.btCylinderShape(this._BtVec3);return this._samePhy(t,r,n),r}}const R=new class{constructor(){}collided(t,e,i,a){t&&e&&t.userData.getSelf&&e.userData.getSelf&&(y=t.isInstancedMesh?this._getIndex(t,i):t.userData.getSelf(),x=e.isInstancedMesh?this._getIndex(e,a):e.userData.getSelf(),y&&x&&this._checkCollider(y,x,t,e,i,a))}_checkCollider(t,e,i,a,r,n){t.collider&&e.data&&t.collider.onCollisionEnter&&t.collider.onCollisionEnter(e,t),e.collider&&t.data&&e.collider.onCollisionEnter&&e.collider.onCollisionEnter(t,e)}_getIndex(t,e){return w=e.getUserPointer(),_=Ammo.castObject(w,Ammo.btVector3).index,t.userData.getSelf(_)}};let P,M,A,H,V,D,z,k,I,U,B,O,W,j,F,L,N;class G{constructor(t){this.removeEffect=null,this._parent=t,this._data=t.data,this.convexBreaker=new THREE.ConvexObjectBreaker,this.fractureImpulse=150,this.maxImpulse=0,this.tinySize=2,this.box=new THREE.Box3,this.boxSize=new THREE.Vector3,this.objectsToRemove=[],this._BtVec3=new Ammo.btVector3,this.impactPoint=new THREE.Vector3,this.impactNormal=new THREE.Vector3}_checkCollider(t,e,i,a){R.collided(t,e,i,a)}update(){if(this._data.dispatcher){for(P=0,A=this._data.dispatcher.getNumManifolds();P<A;P++)if(V=this._data.dispatcher.getManifoldByIndexInternal(P),D=V.getBody0(),z=V.getBody1(),U=D.getUserPointer(),B=z.getUserPointer(),k=Ammo.castObject(U,Ammo.btVector3).threeObject,I=Ammo.castObject(B,Ammo.btVector3).threeObject,(k||I)&&(O=k?k.userData:null,W=I?I.userData:null,O=!!O&&O.breakable,W=!!W&&W.breakable,j=!!O&&O.collided,F=!!W&&W.collided,!j&&!F)){for(this.contact=!1,this.maxImpulse=0,M=0,H=V.getNumContacts();M<H;M++)if(this.contactPoint=V.getContactPoint(M),this.contactPoint.getDistance()<0){this.contact=!0,this.impulse=this.contactPoint.getAppliedImpulse(),this.impulse>this.maxImpulse&&(this.maxImpulse=this.impulse,this.pos=this.contactPoint.get_m_positionWorldOnB(),this.normal=this.contactPoint.get_m_normalWorldOnB(),this.impactPoint.set(this.pos.x(),this.pos.y(),this.pos.z()),this.impactNormal.set(this.normal.x(),this.normal.y(),this.normal.z()));break}this.contact&&((k&&k.userData.getSelf||I&&I.userData.getSelf)&&this._checkCollider(k,I,D,z),(O||W)&&this._SubdivisionUpdate())}for(P=0;P<this.numObjectsToRemove;P++)this.removeDebris(this.objectsToRemove[P]);this.numObjectsToRemove=0}}_SubdivisionUpdate(){if(O&&!j&&this.maxImpulse>this.fractureImpulse){for(this.debris=this.convexBreaker.subdivideByImpact(k,this.impactPoint,this.impactNormal,1,2,1.5),this.numObjects=this.debris.length,M=0;M<this.numObjects;M++)this.debris[M].name=k.name,this._createDebrisFromBreakableObject(this.debris[M]);this.objectsToRemove[this.numObjectsToRemove++]=k,O.collided=!0}if(W&&!F&&this.maxImpulse>this.fractureImpulse){for(this.debris=this.convexBreaker.subdivideByImpact(I,this.impactPoint,this.impactNormal,1,2,1.5),this.numObjects=this.debris.length,M=0;M<this.numObjects;M++)this.debris[M].name=I.name,this._createDebrisFromBreakableObject(this.debris[M]);this.objectsToRemove[this.numObjectsToRemove++]=I,W.collided=!0}}_createDebrisFromBreakableObject(t,e){t.castShadow=!0,t.receiveShadow=!0;const i=t.geometry.attributes.position.array,a=this._createConvexHullPhysicsShape(i);a.setMargin(this._data.margin);const r={object:t,physicsShape:a,mass:t.userData.mass,pos:null,quat:null,vel:t.userData.velocity,angVel:t.userData.angularVelocity},n=this._parent.basic.createBody(r),o=new Ammo.btVector3(0,0,0);return o.threeObject=t,n.setUserPointer(o),e||this._data.debrisBodies.push(t),this.box.setFromObject(t),this.box.getSize(this.boxSize),(this.boxSize.x<this.tinySize||this.boxSize.y<this.tinySize||this.boxSize.z<this.tinySize)&&this.tinyDebris.push(t),n}removeDebris(t){this.removeEffect&&this.removeEffect(t),t.parent.remove(t),t.geometry.dispose(),this._parent.basic.remove(t)}_createConvexHullPhysicsShape(t){let e,i=new Ammo.btConvexHullShape;for(let a=0,r=t.length;a<r;a+=3)this._BtVec3.setValue(t[a],t[a+1],t[a+2]),e=a>=r-3,i.addPoint(this._BtVec3,e);return i}}class q{constructor(t){this.runSpeed=.2,this.jumpSpeed=45,this._func=t.func,this._data=t.data,this._BtVec3=new Ammo.btVector3,this._btQuat=new Ammo.btQuaternion,this.transform=new Ammo.btTransform,this.character=null,this.characterBody=null,this.velocity={x:0,y:0,z:0},this.pos={x:0,y:0,z:0}}createCharacterController(t,e,i,a){if(this.characterBody)return;const r=new Ammo.btCapsuleShape(e,i/2),n=a||t.position;this._BtVec3.setValue(n.x,n.y,n.z),this.transform.setIdentity(),this.transform.setOrigin(this._BtVec3);const o=t.quaternion;this._btQuat.setValue(o.x,o.y,o.z,o.w),this.transform.setRotation(this._btQuat),L=new Ammo.btPairCachingGhostObject,L.setWorldTransform(this.transform),this._data.physicsWorld.getPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback),L.setCollisionShape(r),L.setCollisionFlags(1);const s=new Ammo.btKinematicCharacterController(L,r,1);s.setGravity(-this._data.physicsWorld.getGravity().y()),this._data.physicsWorld.addCollisionObject(L,32,-1),this._data.physicsWorld.addAction(s),s.setJumpSpeed(this.jumpSpeed);const h=new Ammo.btVector3(0,0,0);h.threeObject=t,L.setUserPointer(h),this.character=s,this.characterBody=L}update(){this.character&&(this._BtVec3.setValue(this.velocity.x*this.runSpeed,this.velocity.y||.01,this.velocity.z*this.runSpeed),this.character.setWalkDirection(this._BtVec3),N=this.character.getGhostObject().getWorldTransform().getOrigin(),this.pos.x=N.x(),this.pos.y=N.y(),this.pos.z=N.z())}applyForce(t){this.character&&(this._BtVec3.setValue(t.x||0,t.y||0,t.z||0),this.character.setWalkDirection(this._BtVec3))}Jump(){this.character.jump()}ClimbUp(){this.applyForce({x:0,y:1,z:0})}ClimbDown(){this.applyForce({x:0,y:-1,z:0})}SetGravity(t){void 0!==t?"number"==typeof t&&this.character.setGravity(t):this.character.setGravity(this._data.gravityConstant)}}const Q=[],Y=new WeakMap,K=new WeakMap;let Z,X,$,J,tt,et,it,at,rt,nt;const ot=Object.freeze({DYNAMIC:0,STATIC:1,KINEMATIC:2}),st=Object.freeze({ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5});class ht{constructor(t){this._parent=t,this._data=t.data,this._worldTransform=new Ammo.btTransform,this._bv=new Ammo.btVector3,this._bq=new Ammo.btQuaternion,this._q=new THREE.Quaternion,this._e=new THREE.Euler}get _world(){return this._data.physicsWorld}setGravity(t,e){this._bv.setValue(0,e||0,0),t.setGravity(this._bv)}_getShape(t){const e=t.parameters;if("BoxBufferGeometry"===t.type||"BoxGeometry"===t.type){const t=void 0!==e.width?e.width/2:.5,i=void 0!==e.height?e.height/2:.5,a=void 0!==e.depth?e.depth/2:.5,r=new Ammo.btBoxShape(new Ammo.btVector3(t,i,a));return r.setMargin(.02),r}if("SphereBufferGeometry"===t.type||"IcosahedronBufferGeometry"===t.type||"SphereGeometry"===t.type||"IcosahedronGeometry"===t.type){const t=void 0!==e.radius?e.radius:1,i=new Ammo.btSphereShape(t);return i.setMargin(.05),i}if("CylinderBufferGeometry"===t.type||"CylinderGeometry"===t.type){this._bv.setValue(e.radiusTop||1,e.height||2,e.radiusBottom||1);const t=new Ammo.btCylinderShape(this._bv);return t.setMargin(.1),t}return null}addMesh(t,e=0,i=null){let a;if(a=i?this._getShape(i):this._getShape(t.geometry),a&&t.isInstancedMesh){return this._handleInstancedMesh(t,e,a)}}_handleInstancedMesh(t,e,i){const a=t.instanceMatrix.array,r=[];for(let n=0;n<t.count;n++){const o=16*n,s=new Ammo.btTransform;s.setFromOpenGLMatrix(a.slice(o,o+16));const h=new Ammo.btDefaultMotionState(s),l=new Ammo.btVector3(0,0,0);i.calculateLocalInertia(e,l);const c=new Ammo.btRigidBodyConstructionInfo(e,h,i,l),m=new Ammo.btRigidBody(c);m.setFriction(.8),m.setCcdMotionThreshold(1e-7),this._world.addRigidBody(m),r.push(m),this._addThreeObj(m,t,n)}return e>0&&(t.instanceMatrix.setUsage(35048),Q.push(t),Y.set(t,r)),K.set(t,new Array(t.count)),r}_addThreeObj(t,e,i){e.userData=e.userData||{},e.userData.getSelf=t=>K.get(e)[t],e.userData.removeSelf=t=>{this.desactiveBody(e,t)};const a=new Ammo.btVector3(0,0,0);a.threeObject=e,a.index=i,t.setUserPointer(a)}setMeshPosition(t,e,i=0,a=null){if(!t.isInstancedMesh)return;const r=Y.get(t)[i];this._bv.setValue(0,0,0),r.setAngularVelocity(this._bv),a&&this._bv.setValue(a.x,a.y,a.z),r.setLinearVelocity(this._bv),this._bv.setValue(e.x,e.y,e.z),this._worldTransform.setIdentity(),this._worldTransform.setOrigin(this._bv),r.setWorldTransform(this._worldTransform)}setMeshPosRot(t,e=0,i={},a={},r={}){if(!t.isInstancedMesh)return;const n=Y.get(t)[e];this._bv.setValue(0,0,0),n.setAngularVelocity(this._bv),n.setLinearVelocity(this._bv),this._bv.setValue(r.x||0,r.y||0,r.z||0),n.setLinearVelocity(this._bv),this._setPosDir(n,i,a)}_setPosDir(t,e,i){this._worldTransform.setIdentity(),this._e.set(i.x||0,i.y||0,i.z||0),this._q.setFromEuler(this._e),this._bq.setValue(this._q.x,this._q.y,this._q.z,this._q.w),this._worldTransform.setRotation(this._bq),this._bv.setValue(e.x||0,e.y||0,e.z||0),this._worldTransform.setOrigin(this._bv),t.setWorldTransform(this._worldTransform)}setMeshWithSpeed(t,e,i,a,r,n,o=ot.DYNAMIC){this.setMeshPosRot(t,e,i,a,r);K.get(t)[e]=n;const s=Y.get(t)[e];return s.setActivationState(st.DISABLE_DEACTIVATION),s.setCollisionFlags(o),s}setStaticMesh(t,e,i,a,r,n){this._setPosDir(i,a,r);K.get(t)[e]=n}desactiveBody(t,e){K.get(t)[e]=null,this.setMeshPosRot(t,e,{x:0,y:100*Math.random()-1e3,z:0});const i=Y.get(t);i&&(it=i[e],it.setActivationState(st.DISABLE_SIMULATION))}updateOne(t){for(tt=t.instanceMatrix.array,et=Y.get(t),X=0;X<et.length;X++)it=et[X],at=it.getMotionState(),at.getWorldTransform(this._worldTransform),rt=this._worldTransform.getOrigin(),nt=this._worldTransform.getRotation(),lt(rt,nt,tt,16*X);t.instanceMatrix.needsUpdate=!0}update(){for(Z=0,$=Q.length;Z<$;Z++)J=Q[Z],J.isInstancedMesh&&this.updateOne(J)}remove(t){const e=Q.indexOf(t);e>=0&&Q.splice(e,1);const i=K.get(t);for(Z=0;Z<i.length;Z++)i[Z]=null;if(K.delete(t),it=Y.get(t),it){for(Z=0;Z<it.length;Z++)this._parent.remove(t,it[Z]),it[Z]=null;Y.delete(t)}}}function lt(t,e,i,a){const r=e.x(),n=e.y(),o=e.z(),s=e.w(),h=r+r,l=n+n,c=o+o,m=r*h,d=r*l,u=r*c,p=n*l,f=n*c,g=o*c,v=s*h,y=s*l,x=s*c;i[a+0]=1-(p+g),i[a+1]=d+x,i[a+2]=u-y,i[a+3]=0,i[a+4]=d-x,i[a+5]=1-(m+g),i[a+6]=f+v,i[a+7]=0,i[a+8]=u+y,i[a+9]=f-v,i[a+10]=1-(m+p),i[a+11]=0,i[a+12]=t.x(),i[a+13]=t.y(),i[a+14]=t.z(),i[a+15]=1}class ct{constructor(t){this._parent=t,this._data=t.data,this._addBody=t.basic.addBody.bind(t.basic)}addVirtualBox(t,e){const i=new Ammo.btBoxShape(new Ammo.btVector3(Math.floor(.5*e.width),Math.floor(.5*e.height),Math.floor(.5*e.depth)));return this._parent.basic.addBodyWithMesh(t,i,e.mass,t.position,t.quaternion)}addBody(t){const e=new THREE.BoxGeometry(10,10,10),i=new THREE.Mesh(e,this._parent.collider._mat),a=this._parent.shape.create(i);for(let t of a)this._addBody(t)}_addOneBody(t){const e=this._addBody(t,0,{x:0,y:0,z:0},{x:0,y:0,z:0,w:1});object.userData.collided=!1;const i=new Ammo.btVector3(0,0,0);return i.threeObject=this._addThreeObject(),e.setUserPointer(i),e}_addThreeObject(){}}const{Vector3:mt,Matrix4:dt,BufferGeometry:ut,Quaternion:pt,Box3:ft}=THREE,gt="box",vt="cylinder",yt="sphere",xt="capsule",wt="cone",_t="hull",Et="hacd",bt="vhacd",St="mesh",Tt="heightfield",Ct="all",Rt="manual",Pt=THREE.Object3D.prototype.hasOwnProperty("updateMatrices"),Mt=function(t,e){switch(e.type){case gt:return At(t,e);case vt:return Ht(t,e);case xt:return Vt(t,e);case wt:return Dt(t,e);case yt:return zt(t,e);case _t:return kt(t,e);case Et:return It(t,e);case bt:return Ut(t,e);case St:return Bt(t,e);case Tt:return Ot(t);default:return[]}},At=function(t,e){e.type=gt,Wt(e),e.fit===Ct&&(e.halfExtents=Gt(t,qt(t,e),e.minHalfExtent,e.maxHalfExtent));const i=new Ammo.btVector3(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z),a=new Ammo.btBoxShape(i);return Ammo.destroy(i),jt(a,e,Lt(t)),a},Ht=function(t,e){e.type=vt,Wt(e),e.fit===Ct&&(e.halfExtents=Gt(t,qt(t,e),e.minHalfExtent,e.maxHalfExtent));const i=new Ammo.btVector3(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z),a=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btCylinderShape(i);case"x":return new Ammo.btCylinderShapeX(i);case"z":return new Ammo.btCylinderShapeZ(i)}return null})();return Ammo.destroy(i),jt(a,e,Lt(t)),a},Vt=function(t,e){e.type=xt,Wt(e),e.fit===Ct&&(e.halfExtents=Gt(t,qt(t,e),e.minHalfExtent,e.maxHalfExtent));const{x:i,y:a,z:r}=e.halfExtents,n=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btCapsuleShape(Math.max(i,r),2*a);case"x":return new Ammo.btCapsuleShapeX(Math.max(a,r),2*i);case"z":return new Ammo.btCapsuleShapeZ(Math.max(i,a),2*r)}return null})();return jt(n,e,Lt(t)),n},Dt=function(t,e){e.type=wt,Wt(e),e.fit===Ct&&(e.halfExtents=Gt(t,qt(t,e),e.minHalfExtent,e.maxHalfExtent));const{x:i,y:a,z:r}=e.halfExtents,n=(()=>{switch(e.cylinderAxis){case"y":return new Ammo.btConeShape(Math.max(i,r),2*a);case"x":return new Ammo.btConeShapeX(Math.max(a,r),2*i);case"z":return new Ammo.btConeShapeZ(Math.max(i,a),2*r)}return null})();return jt(n,e,Lt(t)),n},zt=function(t,e){let i;e.type=yt,Wt(e),i=e.fit!==Rt||isNaN(e.sphereRadius)?Nt(t,e,qt(t,e)):e.sphereRadius;const a=new Ammo.btSphereShape(i);return jt(a,e,Lt(t)),a},kt=function(){const t=new mt,e=new mt;return function(i,a){if(a.type=_t,Wt(a),a.fit===Rt)return null;const r=qt(i,a),n=new Ammo.btVector3,o=new Ammo.btConvexHullShape;o.setMargin(a.margin),e.addVectors(r.max,r.min).multiplyScalar(.5);let s=0;Ft(i,a,(t=>{s+=t.attributes.position.array.length/3}));const h=a.hullMaxVertices||1e5,l=Math.min(1,h/s);Ft(i,a,((i,a)=>{Qt(i,a);const r=i.attributes.position.array;for(let i=0;i<r.length;i+=3)Math.random()<=l&&(t.set(r[i],r[i+1],r[i+2]).applyMatrix4(a).sub(e),n.setValue(t.x,t.y,t.z),o.addPoint(n,i===r.length-3))}));let c=o;if(o.getNumVertices()>=100){const t=new Ammo.btShapeHull(o);t.buildHull(a.margin),Ammo.destroy(o),c=new Ammo.btConvexHullShape(Ammo.getPointer(t.getVertexPointer()),t.numVertices()),Ammo.destroy(t)}return Ammo.destroy(n),jt(c,a,Lt(i,a)),c}}(),It=function(){const t=new mt,e=new mt;return function(i,a){if(a.type=Et,Wt(a),a.fit===Rt)return[];if(!Ammo.hasOwnProperty("HACD"))return[];const r=qt(i),n=Lt(i,a);let o=0,s=0;e.addVectors(r.max,r.min).multiplyScalar(.5),Ft(i,a,(t=>{o+=t.attributes.position.array.length/3,t.index?s+=t.index.array.length/3:s+=t.attributes.position.array.length/9}));const h=new Ammo.HACD;a.hasOwnProperty("compacityWeight")&&h.SetCompacityWeight(a.compacityWeight),a.hasOwnProperty("volumeWeight")&&h.SetVolumeWeight(a.volumeWeight),a.hasOwnProperty("nClusters")&&h.SetNClusters(a.nClusters),a.hasOwnProperty("nVerticesPerCH")&&h.SetNVerticesPerCH(a.nVerticesPerCH),a.hasOwnProperty("concavity")&&h.SetConcavity(a.concavity);const l=Ammo._malloc(3*o*8),c=Ammo._malloc(3*s*4);h.SetPoints(l),h.SetTriangles(c),h.SetNPoints(o),h.SetNTriangles(s);const m=l/8,d=c/4;Ft(i,a,((i,a)=>{Qt(i,a);const r=i.attributes.position.array,n=i.index?i.index.array:null;for(let i=0;i<r.length;i+=3)t.set(r[i+0],r[i+1],r[i+2]).applyMatrix4(a).sub(e),Ammo.HEAPF64[m+i+0]=t.x,Ammo.HEAPF64[m+i+1]=t.y,Ammo.HEAPF64[m+i+2]=t.z;if(n)for(let t=0;t<n.length;t++)Ammo.HEAP32[d+t]=n[t];else for(let t=0;t<r.length/3;t++)Ammo.HEAP32[d+t]=t})),h.Compute(),Ammo._free(l),Ammo._free(c);const u=h.GetNClusters(),p=[];for(let t=0;t<u;t++){const e=new Ammo.btConvexHullShape;e.setMargin(a.margin);const i=h.GetNPointsCH(t),r=h.GetNTrianglesCH(t),o=Ammo._malloc(3*i*8),s=Ammo._malloc(3*r*4);h.GetCH(t,o,s);const l=o/8;for(let t=0;t<i;t++){const a=new Ammo.btVector3,r=Ammo.HEAPF64[l+3*t+0],n=Ammo.HEAPF64[l+3*t+1],o=Ammo.HEAPF64[l+3*t+2];a.setValue(r,n,o),e.addPoint(a,t===i-1),Ammo.destroy(a)}jt(e,a,n),p.push(e)}return p}}(),Ut=function(){const t=new mt,e=new mt;return function(i,a){if(a.type=bt,Wt(a),a.fit===Rt)return[];if(!Ammo.hasOwnProperty("VHACD"))return[];const r=qt(i,a),n=Lt(i,a);let o=0,s=0;e.addVectors(r.max,r.min).multiplyScalar(.5),Ft(i,a,(t=>{o+=t.attributes.position.count,t.index?s+=t.index.count/3:s+=t.attributes.position.count/3}));const h=new Ammo.VHACD,l=new Ammo.Parameters;a.hasOwnProperty("resolution")&&l.set_m_resolution(a.resolution),a.hasOwnProperty("depth")&&l.set_m_depth(a.depth),a.hasOwnProperty("concavity")&&l.set_m_concavity(a.concavity),a.hasOwnProperty("planeDownsampling")&&l.set_m_planeDownsampling(a.planeDownsampling),a.hasOwnProperty("convexhullDownsampling")&&l.set_m_convexhullDownsampling(a.convexhullDownsampling),a.hasOwnProperty("alpha")&&l.set_m_alpha(a.alpha),a.hasOwnProperty("beta")&&l.set_m_beta(a.beta),a.hasOwnProperty("gamma")&&l.set_m_gamma(a.gamma),a.hasOwnProperty("pca")&&l.set_m_pca(a.pca),a.hasOwnProperty("mode")&&l.set_m_mode(a.mode),a.hasOwnProperty("maxNumVerticesPerCH")&&l.set_m_maxNumVerticesPerCH(a.maxNumVerticesPerCH),a.hasOwnProperty("minVolumePerCH")&&l.set_m_minVolumePerCH(a.minVolumePerCH),a.hasOwnProperty("convexhullApproximation")&&l.set_m_convexhullApproximation(a.convexhullApproximation),a.hasOwnProperty("oclAcceleration")&&l.set_m_oclAcceleration(a.oclAcceleration);const c=Ammo._malloc(3*o*8),m=Ammo._malloc(3*s*4);let d=c/8,u=m/4;Ft(i,a,((i,a)=>{Qt(i,a);const r=i.attributes.position.array,n=i.index?i.index.array:null;for(let i=0;i<r.length;i+=3)t.set(r[i+0],r[i+1],r[i+2]).applyMatrix4(a).sub(e),Ammo.HEAPF64[d+0]=t.x,Ammo.HEAPF64[d+1]=t.y,Ammo.HEAPF64[d+2]=t.z,d+=3;if(n)for(let t=0;t<n.length;t++)Ammo.HEAP32[u]=n[t],u++;else for(let t=0;t<r.length/3;t++)Ammo.HEAP32[u]=t,u++})),h.Compute(c,3,o,m,3,s,l),Ammo._free(c),Ammo._free(m);const p=h.GetNConvexHulls(),f=[],g=new Ammo.ConvexHull;for(let t=0;t<p;t++){h.GetConvexHull(t,g);const e=g.get_m_nPoints();g.get_m_points();const i=new Ammo.btConvexHullShape;i.setMargin(a.margin);for(let t=0;t<e;t++){const a=new Ammo.btVector3,r=g.get_m_points(3*t+0),n=g.get_m_points(3*t+1),o=g.get_m_points(3*t+2);a.setValue(r,n,o),i.addPoint(a,t===e-1),Ammo.destroy(a)}jt(i,a,n),f.push(i)}return Ammo.destroy(g),Ammo.destroy(h),f}}(),Bt=function(){const t=new mt,e=new mt,i=new mt;return function(a,r){if(r.type=St,Wt(r),r.fit===Rt)return null;const n=Lt(a,r),o=new Ammo.btVector3,s=new Ammo.btVector3,h=new Ammo.btVector3,l=new Ammo.btTriangleMesh(!0,!1);let c;return Ft(a,r,((a,r)=>{const n=a.attributes.position.array;if(a.index)for(let c=0;c<a.index.count;c+=3){const m=3*a.index.array[c],d=3*a.index.array[c+1],u=3*a.index.array[c+2];t.set(n[m],n[m+1],n[m+2]).applyMatrix4(r),e.set(n[d],n[d+1],n[d+2]).applyMatrix4(r),i.set(n[u],n[u+1],n[u+2]).applyMatrix4(r),o.setValue(t.x,t.y,t.z),s.setValue(e.x,e.y,e.z),h.setValue(i.x,i.y,i.z),l.addTriangle(o,s,h,!1)}else for(let a=0;a<n.length;a+=9)t.set(n[a+0],n[a+1],n[a+2]).applyMatrix4(r),e.set(n[a+3],n[a+4],n[a+5]).applyMatrix4(r),i.set(n[a+6],n[a+7],n[a+8]).applyMatrix4(r),o.setValue(t.x,t.y,t.z),s.setValue(e.x,e.y,e.z),h.setValue(i.x,i.y,i.z),l.addTriangle(o,s,h,!1)})),c=r.concave?new Ammo.btBvhTriangleMeshShape(l,!0,!0):new Ammo.btConvexTriangleMeshShape(l,!0),c.resources=[l],Ammo.destroy(o),Ammo.destroy(s),Ammo.destroy(h),jt(c,r,n),c}}(),Ot=function(t){if(Wt(t),t.fit===Ct)return null;const e=t.heightfieldDistance||1,i=t.heightfieldData||[],a=t.heightScale||0,r=t.hasOwnProperty("upAxis")?t.upAxis:1,n="short"===t.heightDataType?Ammo.PHY_SHORT:Ammo.PHY_FLOAT,o=!t.hasOwnProperty("flipQuadEdges")||t.flipQuadEdges,s=i.length,h=s>0?i[0].length:0,l=Ammo._malloc(s*h*4),c=l/4;let m=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,u=0;for(let t=0;t<s;t++)for(let e=0;e<h;e++){const a=i[t][e];Ammo.HEAPF32[c+u]=a,u++,m=Math.min(m,a),d=Math.max(d,a)}const p=new Ammo.btHeightfieldTerrainShape(h,s,l,a,m,d,r,n,o),f=new Ammo.btVector3(e,1,e);return p.setLocalScaling(f),Ammo.destroy(f),p.heightfieldData=l,jt(p,t),p};function Wt(t){t.fit=t.hasOwnProperty("fit")?t.fit:Ct,t.type=t.type||_t,t.minHalfExtent=t.hasOwnProperty("minHalfExtent")?t.minHalfExtent:0,t.maxHalfExtent=t.hasOwnProperty("maxHalfExtent")?t.maxHalfExtent:Number.POSITIVE_INFINITY,t.cylinderAxis=t.cylinderAxis||"y",t.margin=t.hasOwnProperty("margin")?t.margin:.05,t.includeInvisible=!!t.hasOwnProperty("includeInvisible")&&t.includeInvisible,t.offset||(t.offset=new mt),t.orientation||(t.orientation=new pt)}const jt=function(t,e,i){if(t.type=e.type,t.setMargin(e.margin),t.destroy=()=>{for(let e of t.resources||[])Ammo.destroy(e);t.heightfieldData&&Ammo._free(t.heightfieldData),Ammo.destroy(t)},i){const e=new Ammo.btVector3(i.x,i.y,i.z);t.setLocalScaling(e),Ammo.destroy(e)}},Ft=function(){const t=new dt,e=new dt,i=new ut;return function(a,r,n){e.copy(a.matrixWorld).invert(),a.traverse((r=>{r.isMesh&&(r===a?t.identity():(Pt&&r.updateMatrices(),t.multiplyMatrices(e,r.matrixWorld)),n(r.geometry.isBufferGeometry?r.geometry:i.fromGeometry(r.geometry),t))}))}}(),Lt=function(t,e){const{scale:i}=t;return i},Nt=function(){const t=new mt,e=new mt;return function(i,a,r){let n=0,{x:o,y:s,z:h}=r.getCenter(e);return Ft(i,a,((e,i)=>{const a=e.attributes.position.array;for(let e=0;e<a.length;e+=3){t.set(a[e],a[e+1],a[e+2]).applyMatrix4(i);const r=o-t.x,l=s-t.y,c=h-t.z;n=Math.max(n,r*r+l*l+c*c)}})),Math.sqrt(n)}}(),Gt=function(t,e,i,a){return(new mt).subVectors(e.max,e.min).multiplyScalar(.5).clampScalar(i,a)},qt=function(){const t=new mt;return function(e,i){const a=new ft;let r=1/0,n=1/0,o=1/0,s=-1/0,h=-1/0,l=-1/0;return a.min.set(0,0,0),a.max.set(0,0,0),Ft(e,i,((e,i)=>{const a=e.attributes.position.array;for(let e=0;e<a.length;e+=3)t.set(a[e],a[e+1],a[e+2]).applyMatrix4(i),t.x<r&&(r=t.x),t.y<n&&(n=t.y),t.z<o&&(o=t.z),t.x>s&&(s=t.x),t.y>h&&(h=t.y),t.z>l&&(l=t.z)})),a.min.set(r,n,o),a.max.set(s,h,l),a}}(),Qt=(t,e)=>{t.computeBoundingBox();const i=new mt;t.boundingBox.getCenter(i),e.makeTranslation(i.x,i.y,i.z)};class Yt{constructor(t){this._parent=t,this._data=t.data,this._BtVector3=new Ammo.btVector3}create(t,e){void 0===e.collisionFlags&&(e.collisionFlags=e.mass>0?0:1);const i=this.addExisting(t,e);return this._BtVector3.setValue(1,1,1),i.setAngularFactor(this._BtVector3),i}_createShape(t){return Mt(t,{type:"hull"})}mergeCollisionShapesToCompoundShape(t){const e=new Ammo.btCompoundShape;return t.forEach((t=>{const{offset:i}=t,a=new Ammo.btTransform;a.setIdentity(),i&&a.setOrigin(new Ammo.btVector3(i.x||0,i.y||0,i.z||0)),e.addChildShape(a,t)})),e}addExisting(t,e={}){const{position:i,quaternion:a}=t,{shape:r="unknown",compound:n=[],mass:o=1,collisionFlags:s=0,offset:h,breakable:l=!1,addChildren:c=!0}=e;if(n.length>=1){const e=n.map((t=>this.createCollisionShape(t.shape,t))),i=this.mergeCollisionShapesToCompoundShape(e),a=this.collisionShapeToRigidBody(i,t.position,t.quaternion,1);return this.addRigidBodyToWorld(t,a),a}const m=[];if("unknown"!==r||t.isMesh){const i=this.prepareThreeObjectForCollisionShape(t,e),a=this.createCollisionShape(i.shape,i.params,i.object);m.push(a)}if("unknown"===r&&c&&t.children.length>=1&&t.children.forEach((t=>{if(t.isMesh){const e=this.prepareThreeObjectForCollisionShape(t),i=this.createCollisionShape(e.shape,e.params,e.object);i.offset=t.position.clone(),m.push(i)}})),0===m.length){const i=this.prepareThreeObjectForCollisionShape(t,e),a=this.createCollisionShape(i.shape,i.params,i.object);m.push(a)}const d=1===m.length?m[0]:this.mergeCollisionShapesToCompoundShape(m),u=this.collisionShapeToRigidBody(d,i,a,o);return this._addRigidBodyToWorld(t,u,s,l,h),u}_addRigidBodyToWorld(t,e,i=0,a=!1,r={x:0,y:0,z:0}){if(this._data.meshObj[t.uuid])return;this._data.meshObj[t.uuid]=t,t.userData.physicsBody=e,t.userData.collided=!1;const n=new Ammo.btVector3(0,0,0);n.threeObject=t,e.setUserPointer(n),e.setActivationState(0),this._data.physicsWorld.addRigidBody(e),e.setCollisionFlags(i)}prepareThreeObjectForCollisionShape(t,e={}){const{autoCenter:i=!1}=e,a={width:1,height:1,depth:1,radius:1,radiusTop:1,radiusBottom:1,tube:.4,tubularSegments:6};let r="unknown";const n=t.geometry.type||"unknown";/box/i.test(n)?r="box":/cone/i.test(n)?r="cone":/cylinder/i.test(n)?r="cylinder":/extrude/i.test(n)?r="extrude":/plane/i.test(n)?r="plane":/sphere/i.test(n)?r="sphere":/torus/i.test(n)?r="torus":"BufferGeometry"===n&&(r="hacd");let o={...a,...t.geometry.parameters};return e.shape?(o={...a,...e},r=e.shape):t.shape&&(r=t.shape),Object.keys(o).forEach((t=>{void 0===o[t]&&a[t]&&(o[t]=a[t])})),i&&t.geometry.center(),"extrude"===r&&(r="hacd"),"mesh"!==r&&"convex"!==r||(r="convexMesh"),"concave"===r&&(r="concaveMesh"),"unknown"===r&&(r="box"),{shape:r,params:o,object:t}}createCollisionShape(t,e,i){const a=i.quaternion?i.quaternion:new THREE.Quaternion(0,0,0,1),r=Mt;let n;switch(t){case"box":n=new Ammo.btBoxShape(new Ammo.btVector3(e.width/2,e.height/2,e.depth/2));break;case"sphere":n=new Ammo.btSphereShape(e.radius);break;case"cylinder":n=new Ammo.btCylinderShape(new Ammo.btVector3(e.radiusTop,e.height/2,e.radiusBottom));break;case"cone":n=new Ammo.btConeShape(e.radius,e.height);break;case"torus":n=addTorusShape(e,a);break;case"capsule":n=new Ammo.btCapsuleShape(e.radius,e.height);break;case"plane":case"convexMesh":n=r(i,{type:"mesh",concave:!1});break;case"hull":n=r(i,{type:"hull"});break;case"hacd":n=r(i,{type:"hacd"});break;case"vhacd":n=r(i,{type:"vhacd"});break;case"concaveMesh":n=r(i,{type:"mesh",concave:!0})}const{x:o,y:s,z:h}=e;return(o||s||h)&&(n.offset={x:o||0,y:s||0,z:h||0}),Array.isArray(n)&&(n=this.mergeCollisionShapesToCompoundShape(n)),n}collisionShapeToRigidBody(t,e,i,a=1){const r=new Ammo.btTransform;r.setIdentity(),r.setOrigin(new Ammo.btVector3(e.x,e.y,e.z)),r.setRotation(new Ammo.btQuaternion(i.x,i.y,i.z,i.w));const n=new Ammo.btDefaultMotionState(r),o=new Ammo.btVector3(0,0,0);a>0&&t.calculateLocalInertia(a,o);const s=new Ammo.btRigidBodyConstructionInfo(a,n,t,o),h=new Ammo.btRigidBody(s);return a>0&&h.setActivationState(4),h}}class Kt{constructor(t){this._physicsWorld=t.physicsWorld,this._physicsWorld&&(this._rayPos=new Ammo.btVector3,this._rayDir=new Ammo.btVector3,this._rayRes=new Ammo.ClosestRayResultCallback(this._rayPos,this._rayDir),this.hitPos=new THREE.Vector3)}rayHit(t,e){return this._rayPos.setValue(t.x,t.y,t.z),this._rayDir.setValue(e.x,e.y,e.z),this._rayRes.set_m_closestHitFraction(1),this._rayRes.set_m_hitPointWorld(null),this._rayRes.set_m_hitNormalWorld(null),this._rayRes.set_m_rayFromWorld(this._rayPos),this._rayRes.set_m_rayToWorld(this._rayDir),this._physicsWorld.rayTest(this._rayPos,this._rayDir,this._rayRes),this._rayRes.hasHit()?(this.tt=this._rayRes.get_m_collisionObject().getUserPointer(),this.tt?Ammo.castObject(this.tt,Ammo.btVector3).threeObject:null):null}rayHitPoint(t,e){return this._rayPos.setValue(t.x,t.y,t.z),this._rayDir.setValue(e.x,e.y,e.z),this._rayRes.set_m_closestHitFraction(1),this._rayRes.set_m_hitPointWorld(null),this._rayRes.set_m_hitNormalWorld(null),this._rayRes.set_m_rayFromWorld(this._rayPos),this._rayRes.set_m_rayToWorld(this._rayDir),this._physicsWorld.rayTest(this._rayPos,this._rayDir,this._rayRes),this._rayRes.hasHit()?(this.tt=this._rayRes.get_m_collisionObject().getUserPointer(),this.tt?(this.rayP=this._rayRes.get_m_hitPointWorld(),this.hitPos.set(this.rayP.x(),this.rayP.y(),this.rayP.z()),0===this.hitPos.x&&0===this.hitPos.y&&0===this.hitPos.z?{}:{obj:Ammo.castObject(this.tt,Ammo.btVector3).threeObject,point:this.hitPos}):{}):{}}}const Zt=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})(),Xt=(t,e)=>{var i=document.createElement("script");i.onload=()=>{e()},i.onerror=()=>{throw new Error("failed to load "+t)},i.async=!0,i.src=t,document.head.appendChild(i)};let $t,Jt,te,ee,ie,ae,re,ne,oe,se,he=0;class le{constructor(t,e){const{deadPositionY:i=-1e3}=e;this._delY=i,this._parent=t,this._data=t.data}fixUpdate(){if(he>0)return he-=1;he=60,this._fixCheckY()}_fixCheckY(){for($t in this._data.meshObj)Jt=this._data.meshObj[$t],ee=Jt.userData,Jt.position.y>=this._delY||(te=ee.physicsBody,this._parent.remove(Jt,te))}}class ce{constructor(t){this._parent=t}createKinematic(t,e=3,i=6,a=30){const r=new Ammo.btCapsuleShape(e,i/2);return this._parent.basic.addBodyWithMesh(t,r,a)}}class me{constructor(t){this.data=t}create(t){const{mesh:e,heightData:i,terrainWidth:a,terrainDepth:r,size:n=t.size||1,terrainMaxHeight:o=8,terrainMinHeight:s=2}=t,h=this.createTerrainShape({heightData:i,terrainWidthExtents:a*n,terrainDepthExtents:r*n,terrainWidth:a,terrainDepth:r,terrainMaxHeight:o,terrainMinHeight:s}),l=new Ammo.btTransform;l.setIdentity();const c=new Ammo.btVector3(e.position.x,e.position.y+(o+s)/2,e.position.z);l.setOrigin(c);const m=new Ammo.btVector3(0,0,0),d=new Ammo.btDefaultMotionState(l),u=new Ammo.btRigidBodyConstructionInfo(0,d,h,m),p=new Ammo.btRigidBody(u);let f=new Ammo.btVector3(0,0,0);return f.threeObject=e,p.setUserPointer(f),this.data.physicsWorld.addRigidBody(p),p}createTerrainShape(t){const{heightData:e,terrainWidth:i,terrainDepth:a,terrainWidthExtents:r=128,terrainDepthExtents:n=128,terrainMaxHeight:o,terrainMinHeight:s}=t,h=Ammo._malloc(4*i*a);let l=0,c=0;for(let t=0;t<a;t++)for(let t=0;t<i;t++)Ammo.HEAPF32[h+c>>2]=e[l],l++,c+=4;const m=new Ammo.btHeightfieldTerrainShape(i,a,h,2,s,o,1,"PHY_SHORT",!1),d=r/(i-1),u=n/(a-1);return m.setLocalScaling(new Ammo.btVector3(d,1,u)),m.setMargin(.5),m}}class de{constructor(){if(ie)return ie;ie=this,this.update=this.update.bind(this),this.fixUpdate=this.fixUpdate.bind(this)}static load(t={}){return new Promise(((e,i)=>{const a=t.localPhysic?"/lib/ammo":"https://cdn.jsdelivr.net/npm/@enable3d/ammo-physics/ammo";var r,n;r=a,n=()=>{const t=Ammo().then((()=>{globalThis.Ammo=t,e()}))},Xt(Zt?`${r}/ammo.wasm.js`:`${r}/ammo.js`,(()=>n()))}))}_initClass(t){this.data=new S(t),this.basic=new T(this),this.func=new C(this),this.playerFunc=new q(this),this.physicInst=new ht(this),this.shape=new Yt(this),this.env=new ct(this),this.terrain=new me(this.data),this.monster=new ce(this),this.game=new le(this,t)}get count(){Object.keys(this.data.meshObj).length,this.data.staticBodies.length;return this.data.dispatcher.getNumManifolds()}_initAfter(){this.collider=new G(this),this.ray=new Kt(this.data)}async start(t){this._initClass(t),this._initEngine(),this._initAfter()}_initEngine(){const t=this.data,e=new Ammo.btDefaultCollisionConfiguration;t.dispatcher=new Ammo.btCollisionDispatcher(e),t.broadphase=new Ammo.btDbvtBroadphase,t.solver=new Ammo.btSequentialImpulseConstraintSolver,t.physicsWorld=new Ammo.btDiscreteDynamicsWorld(t.dispatcher,t.broadphase,t.solver,e),t.physicsWorld.setGravity(new Ammo.btVector3(0,-t.gravityConstant,0))}update(t){this.basic&&this.basic.update(t),this.collider&&this.collider.update(t),this.physicInst&&this.physicInst.update(),this.data&&(this.data.physicsWorld.stepSimulation(t,10),this.playerFunc&&this.playerFunc.update())}fixUpdate(){this.game&&this.game.fixUpdate()}remove(t,e){this.basic.remove(t,e)}}class ue{constructor(t){this._isStop=!1,this.scene=t,this.renderer=t.renderer,this.Hwidth=this.scene.w/2,this.Hheight=this.scene.h/2,this.UICamera=null,this.UIScene=null,this.render=this.render.bind(this),this.onWindowResize=this.onWindowResize.bind(this),this.init()}init(){const t=new THREE.OrthographicCamera(-this.Hwidth,this.Hwidth,this.Hheight,-this.Hheight,-100,100);t.position.z=10,this.UIScene=new THREE.Scene,this.UIScene.name="UIScene",this.UICamera=t}render(t){this._isStop||this.renderer&&this.UIScene&&this.UICamera&&this.renderer.render(this.UIScene,this.UICamera)}onWindowResize(){this.Hwidth=this.scene.w/2,this.Hheight=this.scene.h/2,this.UICamera.left=-this.Hwidth,this.UICamera.right=this.Hwidth,this.UICamera.top=this.Hheight,this.UICamera.bottom=-this.Hheight,this.UICamera.updateProjectionMatrix()}add(t){this.UIScene.add(t)}}class pe{constructor(t){this.pass=null,this.selects=[],this.init(t)}init(t){const e=new THREE.SSRrPass({renderer:t.renderer,scene:t.scene,camera:t.camera,width:t.w,height:t.h,encoding:THREE.sRGBEncoding,selects:this.selects});e.ior=1.1,e.surfDist=.0015,e.maxDistance=50,this.pass=e}add(t){this.selects.push(t)}remove(t){let e=this.selects.indexOf(t);e>=0&&this.selects.splice(e,1)}}class fe{constructor(t){this._parent=t,this.renderer=t.renderer,this.scene=t.scene,this.camera=t.camera,this.w=this._parent.w,this.h=this._parent.h,this.params={exposure:.98,bloomStrength:1.8,bloomThreshold:.6,bloomRadius:.5},this.composer=null,this.render=this.render.bind(this),this.init(),t.vignette&&(this.vignette=this._makeVignette()),t.ssao&&(this.ssao=this._makeSSAO()),t.bloom&&(this.bloom=this._makeBloom()),t.ssrr&&(this.ssrr=this._makeSSRr()),t.lut&&this._make3dlut()}get texture(){return this.bloom?this.bloom.materialCopy:null}set DarkCorner(t){this.vignette&&(this.vignette.uniforms.offset.value=t?.5:0,this.vignette.uniforms.darkness.value=t?2:1)}_makeSSRr(){const t=new pe(this);return this.composer.addPass(t.pass),t}_makeSAO(){const t=new THREE.SAOPass(this.scene,this.camera,!1,!0);t.params.output=THREE.SAOPass.OUTPUT.Default,t.params.saoBias=.2,t.params.saoIntensity=.1,t.params.saoScale=1,t.params.saoKernelRadius=50,t.params.saoMinResolution=0,t.params.saoBlur=!0,t.params.saoBlurRadius=8,t.params.saoBlurStdDev=4,t.params.saoBlurDepthCutoff=.01,this.composer.addPass(t)}_makeSSR(){const t=new THREE.SSRPass({renderer:this.renderer,scene:this.scene,camera:this.camera,width:this.w,height:this.h,encoding:THREE.sRGBEncoding,isPerspectiveCamera:!0,groundReflector:null,selects:null});this.composer.addPass(t)}_make3dlut(){this.lutMap={"Remy_24.CUBE":null},this.composer.addPass(new THREE.ShaderPass(THREE.GammaCorrectionShader));const t=new THREE.LUTPass;t.intensity=1,this.composer.addPass(t),Object.keys(this.lutMap).forEach((e=>{(new THREE.LUTCubeLoader).load("texture/lut/"+e,(i=>{this.lutMap[e]=i,t.lut=i.texture3D}))}))}_makeVignette(){const t=THREE.VignetteShader,e=new THREE.ShaderPass(t);return e.uniforms.offset.value=.6,e.uniforms.darkness.value=1.8,this.composer.addPass(e),e}_makeBloom(){const t=new THREE.UnrealBloomPass(new THREE.Vector2(this.w,this.h),1.5,.4,.85);return t.threshold=this.params.bloomThreshold,t.strength=this.params.bloomStrength,t.radius=this.params.bloomRadius,this.composer.addPass(t),t}_makeSSAO(){const t=new THREE.SSAOPass(this.scene,this.camera,this.w,this.h);return t.output=THREE.SSAOPass.OUTPUT.Default,t.kernelRadius=16,t.minDistance=.01,t.maxDistance=.1,this.composer.addPass(t),t}_makeOutline(){const t=5,e=.5,i=1,a=15790080,r="#ff5f9f",n=new THREE.OutlinePass(new THREE.Vector2(this.w,this.h),this.scene,this.camera);n.edgeStrength=t,n.edgeGlow=e,n.edgeThickness=i,n.visibleEdgeColor.set(a),n.hiddenEdgeColor.set(r),this.composer.addPass(n)}setOutline(t){this.outline&&(this.outline.selectedObjects=t)}init(){this.renderer.toneMappingExposure=Math.pow(this.params.exposure,4);const t=new THREE.RenderPass(this.scene,this.camera),e=new THREE.EffectComposer(this.renderer);e.addPass(t),this.composer=e}render(t,e){this.composer.render()}setSize(){this.composer.setSize(this._parent.w,this._parent.h)}}class ge{static check(t=this._data.cameraWorldPos){return ae=DB.phy.ray.rayHit(DB.player.data.pos,t),!!ae&&("CAMERA"!==ae.name&&"LOCAL_PLAYER"!==ae.name)}static checkToPlayer(t=this._data.cameraWorldPos){return ae=DB.phy.ray.rayHit(t,DB.player.data.pos),!ae||"CAMERA"!==ae.name&&("LOCAL_PLAYER"!==ae.name&&("ONLINE_PLAYER"!==ae.name&&(!ae.userData.physicsBody||!!ae.userData.physicsBody.isStaticObject())))}}class ve{constructor(t){this._parent=t,this._data=t._data}get body(){return this._body||(this._body=this._addBody("CAMERA")),this._body}seeNextPos(){return this.body?(DB.phy.func.setPosition(this.body,this._data.lastPos),re=ge.check(this._data.lastPos),!!re):this.body=this._addBody("CAMERA")}seeNextPos222(){return re=DB.phy.ray.rayHitPoint(this._data.cameraWorldPos,this._data.lastPos),!(!re||re==={})&&(!(!this._data.cameraWorldPos||!re.point)&&(ne=this._data.cameraWorldPos.distanceTo(this._data.lastPos),oe=this._data.cameraWorldPos.distanceTo(re.point),!1))}_addBody(t){const e={uuid:Date.now()+Math.floor(1e3*Math.random()),name:t,position:{x:0,y:0,z:0,set:(t,e,i)=>{}},quaternion:{x:0,y:0,z:0,w:1,set:()=>!1},userData:{getSelf:()=>this}};return DB.phy.env.addVirtualBox(e,{type:"box",mass:1e-4,collisionFlags:4,width:1,height:1,depth:1})}}let ye=0;class xe{constructor(t){this._parent=t,this._data=t._data;const e=t._parent;this._root=e,this._cameras=[e.cameras.back,e.cameras.back_2,e.cameras.back_3,e.cameras.back_4,e.cameras.back_5,e.cameras.back_6],this._cInd=0,this._c=this._cameras[this._cInd]}set cc(t){t!==this._cInd&&(this._cInd=t,this._c=this._cameras[this._cInd],this._root.activeCamera=this._c,DB.player&&(DB.player.visible=!(this._cInd>=this._cameras.length-2)))}fixUpdate(){this._cameraMove()}_cameraMove(){return ye>0?ye-=1:(ye=3,this._data.isInWall?this._cInd>=this._cameras.length-1?this._cInd=this._cameras.length-1:void(this.cc=this._cInd+1):void(this._cInd<=0||this.tryBack()))}tryBack(){se=this._cInd-1,this._cameras[se].getWorldPosition(this._data.lastPos),this._data.isLastInWall=this._parent.inwall_Collider.seeNextPos(this._data.lastPos),this._data.isLastInWall||(this.cc=se)}}class we{constructor(t){this._parent=t,this._data=t.data,this.move=new xe(this),this.inwall_Collider=new ve(this)}fixUpdate(){DB.player&&(this._data.isPlayingAnimat||(this._checkInWall(),this.move.fixUpdate()))}_checkInWall(){this._data.isInWall=ge.checkToPlayer(this._data.cameraWorldPos)}}class _e{constructor(t){this.scene=t,this.startTime=null,this.t=null,this.samples=[],this.isShaking=!1}start(t,e){this.duration=t,this.frequency=e;const i=t/1e3*e;this.samples.length=0;for(let t=0;t<i;t++)this.samples.push(2*Math.random()-1);this.startTime=this.scene.time,this.t=0,this.isShaking=!0}update(){this.isShaking&&(this.t=this.scene.time-this.startTime,this.t>this.duration&&(this.isShaking=!1))}amplitude(t){if(void 0===t){if(!this.isShaking)return 0;t=this.t}const e=t/1e3*this.frequency,i=Math.floor(e),a=i+1,r=this.decay(t);return(this.noise(i)+(e-i)*(this.noise(a)-this.noise(i)))*r}noise(t){return t>=this.samples.length?0:this.samples[t]}decay(t){return t>=this.duration?0:(this.duration-t)/this.duration}}class Ee{constructor(t,e){this.shakeRot=t.shakeRot,this.xShake=new _e(e),this.yShake=new _e(e)}start(t=1,e=1,i=.2){const a=1e3*t,r=60*e;this.AMPLITUDE=i,this.xShake.start(a,r),this.yShake.start(a,r)}update(t){if(this.xShake.update(t),this.yShake.update(t),!this.xShake.isShaking&&!this.yShake.isShaking)return this.shakeRot.x=0,void(this.shakeRot.y=0);this.shakeRot.x=this.xShake.amplitude()*this.AMPLITUDE,this.shakeRot.y=this.yShake.amplitude()*this.AMPLITUDE}}let be,Se,Te,Ce=0;class Re{constructor(t){this._parent=t,this._data=t.data,this._originalObj=null,this._playList=[],this._obj=new THREE.Object3D}fixUpdate(){if(be)return Ce>0?Ce-=1:this._playList.length<=0?(be=null,this._parent.cameraTarget=this._originalObj,this._parent.activeCamera=this._parent.cameras.back,this._data.isSlowLerp=!1,void(this._data.isPlayingAnimat=!1)):void this._set()}play(t){if(!be){this._data.isPlayingAnimat=!0,this._data.isSlowLerp=!0,this._originalObj=DB.player.mesh;for(let e of t)this._playList.push(e);this._set()}}_set(){be=this._playList.shift(),Ce=be.time,this._parent.activeCamera=be.cp||this._parent.cameras.top,this._parent.cameraTarget=this._obj,be.target||this._obj.position.set(be.pos.x,be.pos.y,be.pos.z)}t2(t){this.play([{time:120,cp:this._parent.cameras.overhead,pos:t},{time:120,pos:t}])}}class Pe{constructor(t){this._parent=t,this._data=t.data,this._current=null}run(){this._current===this._parent.cameras.zoom?this._zoomOut():this._zoomIn(),this._current=this._parent.activeCamera}_zoomIn(){this._parent.zoomIn()}_zoomOut(){this._parent.back()}}class Me{constructor(t){this._camera=t.camera,this._originalVal=this._camera.fov,this._goVal=this._originalVal,this._time=0}update(t,e){this._camera.fov>=this._goVal-.001&&this._camera.fov<=this._goVal+.001||(this._camera.fov=THREE.Math.lerp(this._camera.fov,this._goVal,e),this._camera.updateProjectionMatrix())}fixUpdate(){if(this._goVal!==this._originalVal)return this._time>0?this._time-=1:void(this._goVal=this._originalVal)}setDurant(t,e=1){this._goVal=t,this._time=e}update2(t,e){this._camera.fov!==this._originalVal&&(this._camera.fov=THREE.Math.lerp(this._camera.fov,this._originalVal,e),this._camera.updateProjectionMatrix())}set val(t){this._camera.fov=t}}class Ae{constructor(t){if(Se)return Se;Se=this,this.data={cameraWorldPos:new THREE.Vector3,cameraWorldQuat:new THREE.Quaternion,cameraTargetPos:new THREE.Vector3,lastPos:new THREE.Vector3,isInWall:!1,isLastInWall:!1,yView:20,xView:0,zDistance:0,maxZ:40,shakeRot:new THREE.Euler(0,0,0),isSlowLerp:!1,isPlayingAnimat:!1},this.camera=t.camera,this.shake=new Ee(this.data,t),this.zoom=new Pe(this),this.animat=new Re(this),this.fov=new Me(this),this._obj=null,this.cameras,this._vec2=new THREE.Vector3,this.update=this.update.bind(this),this.fixUpdate=this.fixUpdate.bind(this),this.createCameras(),this.cameraInWallCheck=new we(this)}update(t,e){this.updateCamera(t,e),this.fov&&this.fov.update(t,e),this.shake.update(t,e)}fixUpdate(){this.fov&&this.fov.fixUpdate(),this.cameraInWallCheck.fixUpdate(),this.animat.fixUpdate()}set cameraTarget(t){this._obj=t;for(let e in this.cameras)this.cameras[e].parent=t;this.data.zDistance=0}get cameraTarget(){return this._obj}get activeCamera(){return this._activeCamera||this.cameras.back}set activeCamera(t){this._activeCamera=t,t.userData.extra&&(this.data.yView=t.userData.extra.yView||0,this.data.xView=t.userData.extra.xView||0,this.data.zView=t.userData.extra.zView||100)}set backPos(t){this.cameras.back.position.set(t.x,t.y,t.z)}createCameras(){const t=new THREE.Object3D;t.name="zoom",t.position.set(-2,5,5),t.userData.extra={yView:6,xView:0};const e=new THREE.Object3D;e.name="back",e.position.set(-5,10,-30),e.userData.extra={yView:6};const i=new THREE.Object3D;i.position.set(-5,8,-24),i.userData.extra={yView:6};const a=new THREE.Object3D;a.position.set(-5,7,-16),a.userData.extra={yView:5};const r=new THREE.Object3D;r.position.set(-4,7,-8),r.userData.extra={yView:4};const n=new THREE.Object3D;n.position.set(-2,6,-2),n.userData.extra={yView:4};const o=new THREE.Object3D;o.position.set(0,5,1),o.userData.extra={yView:4};const s=new THREE.Object3D;s.name="wide",s.position.set(0,30,-85),s.userData.extra={yView:20};const h=new THREE.Object3D;h.name="overhead",h.position.set(0,60,-120),h.userData.extra={yView:-50};const l=new THREE.Object3D;l.name="collect",l.position.set(0,8,30),l.userData.extra={yView:8};const c=new THREE.Object3D;c.name="front",c.position.set(0,30,125),c.userData.extra={yView:25};const m=new THREE.Object3D;m.position.set(120,30,0),m.userData.extra={yView:20,zView:10};const d=new THREE.Object3D;d.position.set(-120,30,0),d.userData.extra={yView:20,zView:10};const u=new THREE.Object3D;u.position.set(0,150,50),u.userData.extra={xView:0,yView:0,zView:-30};const p=new THREE.Object3D;p.position.set(0,20,-45),this.cameras=Object.freeze({zoom:t,back:e,back_2:i,back_3:a,back_4:r,back_5:n,back_6:o,wide:s,overhead:h,collect:l,front:c,left:m,right:d,top:u,chat:p}),this.activeCamera=this.cameras.back}_updateCameraTargetPos(){this.data.cameraTargetPos.set(this.data.xView,this.data.yView,this.data.zView).applyQuaternion(this.cameraTarget.quaternion).add(this.cameraTarget.position).applyEuler(this.data.shakeRot)}updateCamera(t,e){void 0!==this.cameras&&void 0!==this.activeCamera&&this.cameraTarget&&(this.activeCamera.getWorldPosition(this.data.cameraWorldPos),this._updateCameraTargetPos(),this.camera.position.lerp(this.data.cameraWorldPos,this.data.isSlowLerp?t:e),this._vec2.lerp(this.data.cameraTargetPos,e),this.camera.lookAt(this._vec2),this.camera.getWorldQuaternion(this.data.cameraWorldQuat))}inChat(){this.activeCamera=this.cameras.chat}zoomIn(){this.activeCamera=this.cameras.zoom}back(){this.activeCamera=this.cameras.back,this.cameraInWallCheck.move.cc=0}overhead(){this.activeCamera=this.cameras.overhead}wide(){this.activeCamera=this.cameras.wide}collect(){this.activeCamera=this.cameras.collect}}class He{constructor(t){this._parent=t,this._v=t.data.pos,this._d=t.data.dir,this.data=t.data,this.init()}init(){this._initPoint(),this._initEffectPoint()}_initPoint(){const t=new THREE.PointLight(6710886,.7);if(t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,t.shadow.camera.near=.01,t.shadow.camera.far=600,t.shadow.bias=-.01,t.shadow.radius=2,t.distance=800,t.castShadow=!0,this._parent.scene.add(t),this.point=t,DB.DEBUG){const t=new THREE.SphereBufferGeometry(6),e=new THREE.MeshBasicMaterial({wireframe:!0}),i=new THREE.Mesh(t,e);this.point.add(i)}}_followPlayer(t){this._setPos(),this.point.position.lerp(this._v,t)}_setPos(){this._v.set(0,200,10).applyEuler(this._d.set(0,this._parent.cameraControl.cameraTarget.rotation.y,0)).add(this._parent.cameraControl.cameraTarget.position)}update(t,e){this.point&&this._parent.cameraControl.cameraTarget&&(this.data.isset&&this.updateSet(t),this._followPlayer(e))}_initEffectPoint(){const t=new THREE.PointLight(6710886,.7);if(t.distance=50,t.castShadow=!1,this._parent.scene.add(t),this.point2=t,DB.DEBUG){const t=new THREE.SphereBufferGeometry(2),e=new THREE.MeshBasicMaterial({wireframe:!0}),i=new THREE.Mesh(t,e);this.point2.add(i)}}updateSet(t){this.point2.intensity=THREE.Math.lerp(this.point2.intensity,0,t),this.point2.intensity>.05||this.backFunc()}backFunc(){this.data.isset=!1}emit(t,e=16777215,i=1.5,a=50){this.data.isset=!0,this.point2.position.set(t.x,t.y+8,t.z),this.point2.color.setHex(e),this.point2.intensity=i,this.point2.distance=a}}class Ve extends class{constructor(t){this.name=t,this.components=[],this.fixUpdate=this.fixUpdate.bind(this),this.update=this.update.bind(this)}fixUpdate(){for(Te of this.components)Te.fixUpdate()}update(t,e){for(Te of this.components)Te.update(t,e)}addComponent(t,...e){const i=this.components.findIndex((e=>e instanceof t));if(i>=0)return this.components[i];const a=new t(this,...e);return a.fixUpdate||(a.fixUpdate=()=>{}),a.update||(a.update=()=>{}),this.components.push(a),a}removeComponent(t){const e=this.components.findIndex((e=>e instanceof t));e>=0&&(this.components[e].deinit&&this.components[e].deinit(),this.components.splice(e,1))}getComponent(t){return this.components.find((e=>e instanceof t))}hasComponent(t){return this.components.findIndex((t=>t instanceof Te))>=0}}{constructor(t){super("Light"),this.scene=t.scene,this.cameraControl=t.cameraControl,this.data={pos:new THREE.Vector3,dir:new THREE.Euler},this.init()}init(){this.point=this.addComponent(He,this),this._initHemi(),this._initAmb()}_initSun(){const t=256,e=new THREE.DirectionalLight(7303023,1);e.shadow.bias=.001,e.position.set(0,100,-50),e.castShadow=!0,e.shadow.camera.top=t,e.shadow.camera.bottom=-256,e.shadow.camera.left=-256,e.shadow.camera.right=t,e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,this.scene.add(e),this._v=new THREE.Vector3,this.sun=e}_updateSun(){this.sun&&this.playerObject&&(this.sun.position.x=this.playerObject.position.x,this.sun.position.y=this.playerObject.position.y+120,this.sun.position.z=this.playerObject.position.z+60,this.sun.target=this.playerObject)}_initHemi(){const t=new THREE.HemisphereLight(15724511,3684408,.2);this.scene.add(t),this.hemi=t}_initAmb(){const t=new THREE.AmbientLight(16185078,.15);this.scene.add(t),this.amb=t}setRedAmibient(){}}Object.freeze({START_WALK:1});let De,ze,ke,Ie=new Map;class Ue{constructor(){}static get evs(){return Ie}static on(t,e,i){Ie.has(t)||Ie.set(t,[]),Ie.get(t).push({func:e,target:i})}static off(t,e,i){if(ze=Ie.get(t),ze&&!(ze.length<=0))for(De=0;De<ze.length;De++)if(ke=ze[De],ke.func===e&&(!i||i===ke.target)){ze.splice(De,1);break}}static dispatch(t,...e){if(ze=Ie.get(t),ze&&!(ze.length<=0))for(ke of ze)ke.func.call(ke.target,...e)}static once(t,e,i){const a=(...r)=>{e.call(i,...r),this.off(t,a,i)};this.on(t,a,i)}}const Be={vec:new THREE.Vector3,dir:new THREE.Vector3,ray:new THREE.Raycaster,box:new THREE.Box3};var Oe={...Be,halfPI:Math.PI/2,twoPI:2*Math.PI,l:(...t)=>null,sleep:function(t){return new Promise(((t,e)=>{t()}),1e3*t)},ms:t=>new Promise(((t,e)=>{t()}),t),uuid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})),getQueryParams:function(){var t=window.location.search;if(t){t=t.split("+").join(" ");for(var e,i={},a=/[?&]?([^=]+)=([^&]*)/g;e=a.exec(t);)i[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return i}},normalize:function(t,e,i,a,r){return a+(Math.max(Math.min(t,i),e)-e)/(i-e)*(r-a)},clamp:function(t,e=0,i=1){return Math.min(Math.max(t,e),i)},uniqueArray:function(t){return t.filter(((t,e,i)=>i.indexOf(t)===e))},weightRandom:function(t){let e=0;for(const[,i]of t)e+=i;let i=Math.random()*e;for(const[e,a]of t)if((i-=a)<0)return e;return t[t.length-1]},listRandom:function(t){return t[Math.floor(Math.random()*t.length)]},toDecimal:function(t){var e=parseFloat(t);if(!isNaN(e))return e=~~(100*t)/100},getMinusInRange:function(t,e,i){var a=i;return t<-e?a=i:(t>e||t<e&&t>0)&&(a=-i),a},isMobile:function(){var t=!1;return(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(t=!0),(/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&(t=!0),t},isIOS:function(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document},_typeof:We,util:function(){var t={};function e(e){return t[Object.prototype.toString.call(e)]||"object"}return["Null","Undefined","Number","Boolean","String","Object","Function","Array","RegExp","Date"].forEach((function(e){t["[object "+e+"]"]=e.toLowerCase()})),{isType:function(t,i){return e(t)===i},getType:e}}(),deepCopy:function t(e,i){if(null===e||"object"!=typeof e)return e;var a,r,n,o=util.isType(e,"array")?[]:{};for(a in e)r=e[a],n=util.getType(r),o[a]=!i||"array"!==n&&"object"!==n?r:t(r);return o},isNull:function(t){if(null==t)return!0;return"string"===We(t)&&""===(t=je(t))},delSpace:je,getRandomIntInRange:function(t,e){return parseInt(Math.random()*e,10)+t},Olength:function(t){return Object.keys(t).length},degToDirection:function(t){t<0&&(t+=360);var e=Math.floor(t/45+.5),i=[1,2,3,4,5,6,7,8];return(e%=16)>=i.length&&(e=0),i[e]},angleToRadian:function(t){return(t=(t=t>=360?t-360:t)<0?t+360:t)*Math.PI/180},radianToAngle:function(t){return 180/(Math.PI/t)},getAngle:function(t,e,i,a){var r=i-t,n=a-e,o=r/Math.sqrt(Math.pow(r,2)+Math.pow(n,2)),s=Math.acos(o),h=180/(Math.PI/s);return~~(h=h||0)},getAngle2:function(t,e,i,a){var r=i-t,n=a-e;let o=Math.atan2(n,r);return o/=Math.PI/180,o-=90,o=-o,o},getRadian:function(t,e,i,a){return Math.atan2(a-e,i-t)},dirToRadian:function(t){return Math.atan2(t.z,t.x)},radianToDir:function(t){return{x:Math.cos(t),z:Math.sin(t)}},getDistance:function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.z-e.z,2))},get3DDistance:function(t,e){var i=t.x-e.x,a=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+a*a+r*r)},getDisToLine:function(t,e,i){function a(t){return t*t}function r(t,e){return a(t.x-e.x)+a(t.z-e.z)}var n=r(e,i);if(0==n)return r(t,e);var o=((t.x-e.x)*(i.x-e.x)+(t.z-e.z)*(i.z-e.z))/n;return r(t,o<0?e:o>1?i:{x:e.x+o*(i.x-e.x),z:e.z+o*(i.z-e.z)})},getDisToLine3D:function(t,e,i){function a(t){return t*t}function r(t,e){return a(t.x-e.x)+a(t.y-t.y)+a(t.z-e.z)}var n=r(e,i);if(0===n)return r(t,e);var o=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y)+(t.z-e.z)*(i.z-e.z))/n;return r(t,o<0?e:o>1?i:{x:e.x+o*(i.x-e.x),y:e.y+o*(i.y-e.y),z:e.z+o*(i.z-e.z)})},CircularLayout:function(t,e,i){i=i||{x:0,y:0};var a,r,n=[];for(a=r=0;r<t;a=++r){var o=i.x+e*Math.sin(2*Math.PI*a/t),s=i.y+e*Math.cos(2*Math.PI*a/t);n.push({x:o,y:s})}return n},posCircular:function(t,e,i){return{x:t*Math.sin(2*Math.PI*e/i),z:t*Math.cos(2*Math.PI*e/i)}},randomInSphere:function(t){return Be.vec.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize().multiplyScalar(t*Math.random())},randomInSphereSurface:function(t,e){let i=-.5*Math.random();return e&&i<-.2&&(i=-i),Be.vec.set(Math.random()-.5,i,Math.random()-.5).normalize().multiplyScalar(t)},randomInCircle:function(t,e){return Be.vec.set(Math.random()-.5,0,Math.random()-.5).normalize().multiplyScalar(t-e+e*Math.random())},randomPosInRadius:function(t,e){var i=360*Math.random(),a=Math.sin(2*Math.PI/360)*i,r=Math.sin(a)*e,n=Math.cos(a)*e;return t.x+=n,t.y+=r,t},forward:function(t,e,i){t.z+=Math.sin(e)*i,t.x+=Math.cos(e)*i},MLength:function(t,e){e=e||THREE.Mesh;var i=0;return t.traverse((function(a){a instanceof e&&(a.name?i+=1:t.remove(a))})),i},getPointInBetweenByPerc:function(t,e,i){i=i||.5;let a=Be.vec;a.copy(e);let r=a.sub(t),n=r.length();return r=r.normalize().multiplyScalar(n*i),a.copy(t),a.add(r),a},posRound:function(t){return{x:~~t.x,y:~~t.y,z:~~t.z}},loadCollada:function(t,e){var i=new THREE.ColladaLoader;i.options.convertUpAxis=!0,i.load(t,(function(t){var i=t.scene;i.traverse((function(t){t instanceof THREE.SkinnedMesh&&new THREE.Animation(t,t.geometry.animation).play()})),i.scale.x=i.scale.y=i.scale.z=.002,i.position.x=-1,i.updateMatrix(),e(i)}))},position2Screen:function(t,e,i,a){if(t&&e&&t.matrixWorld)return Be.vec.setFromMatrixPosition(t.matrixWorld),Be.vec.project(e),Be.vec.x=Be.vec.x*i,Be.vec.y=-Be.vec.y*a,Be.vec},roundRect:function(t,e,i,a,r,n){t.beginPath(),t.moveTo(e+n,i),t.lineTo(e+a-n,i),t.quadraticCurveTo(e+a,i,e+a,i+n),t.lineTo(e+a,i+r-n),t.quadraticCurveTo(e+a,i+r,e+a-n,i+r),t.lineTo(e+n,i+r),t.quadraticCurveTo(e,i+r,e,i+r-n),t.lineTo(e,i+n),t.quadraticCurveTo(e,i,e+n,i),t.closePath(),t.fill()},removeMesh:function(t,e){var i=t.getObjectByName(e.name);t.remove(i),animate()},getMeshParameters:function(t){return t.geometry.parameters},getMeshSize:function(t,e){this.box.setFromObject(t).getSize(e)},Base64:{_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var e,i,a,r,n,o,s,h="",l=0;for(t=Base64._utf8_encode(t);l<t.length;)r=(e=t.charCodeAt(l++))>>2,n=(3&e)<<4|(i=t.charCodeAt(l++))>>4,o=(15&i)<<2|(a=t.charCodeAt(l++))>>6,s=63&a,isNaN(i)?o=s=64:isNaN(a)&&(s=64),h=h+this._keyStr.charAt(r)+this._keyStr.charAt(n)+this._keyStr.charAt(o)+this._keyStr.charAt(s);return h},decode:function(t){var e,i,a,r,n,o,s="",h=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");h<t.length;)e=this._keyStr.indexOf(t.charAt(h++))<<2|(r=this._keyStr.indexOf(t.charAt(h++)))>>4,i=(15&r)<<4|(n=this._keyStr.indexOf(t.charAt(h++)))>>2,a=(3&n)<<6|(o=this._keyStr.indexOf(t.charAt(h++))),s+=String.fromCharCode(e),64!=n&&(s+=String.fromCharCode(i)),64!=o&&(s+=String.fromCharCode(a));return s=Base64._utf8_decode(s)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",i=0;i<t.length;i++){var a=t.charCodeAt(i);a<128?e+=String.fromCharCode(a):a>127&&a<2048?(e+=String.fromCharCode(a>>6|192),e+=String.fromCharCode(63&a|128)):(e+=String.fromCharCode(a>>12|224),e+=String.fromCharCode(a>>6&63|128),e+=String.fromCharCode(63&a|128))}return e},_utf8_decode:function(t){for(var e="",i=0,a=0,r=0;i<t.length;)if((a=t.charCodeAt(i))<128)e+=String.fromCharCode(a),i++;else if(a>191&&a<224)r=t.charCodeAt(i+1),e+=String.fromCharCode((31&a)<<6|63&r),i+=2;else{r=t.charCodeAt(i+1);var n=t.charCodeAt(i+2);e+=String.fromCharCode((15&a)<<12|(63&r)<<6|63&n),i+=3}return e}},ab2str:function(t){return String.fromCharCode.apply(null,new Uint8Array(t))},str2ab:function(t){for(var e=new ArrayBuffer(1*t.length),i=new Uint8Array(e),a=0,r=t.length;a<r;a++)i[a]=t.charCodeAt(a);return e},ab162str:function(t){return String.fromCharCode.apply(null,new Uint16Array(t))},Utf8ArrayToStr:function(t){var e,i,a,r,n,o;for(e="",a=t.length,i=0;i<a;)switch((r=t[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:e+=String.fromCharCode(r);break;case 12:case 13:n=t[i++],e+=String.fromCharCode((31&r)<<6|63&n);break;case 14:n=t[i++],o=t[i++],e+=String.fromCharCode((15&r)<<12|(63&n)<<6|(63&o)<<0)}return e}};function We(t){var e={};return"Boolean Number String Function Array Date RegExp Object Error".split(" ").forEach((function(t,i){e["[object "+t+"]"]=t.toLowerCase()})),null===t?String(t):"object"==typeof t||"function"==typeof t?e[e.toString.call(t)]||"object":typeof t}function je(t){return t=(t=t.trim()).replace(/\s+/g,"")}let Fe,Le,Ne;class Ge{constructor(){if(Fe)return Fe;Fe=this,this._v=new THREE.Vector3,this._s=new THREE.Vector3,this._d=new THREE.Euler,this._q=new THREE.Quaternion(0,0,0,1),this._matrix=new THREE.Matrix4,this._c=new THREE.Color,this._o=new THREE.Object3D}getMatrix(t,e={},i={}){return this._d.set(e.x||0,e.y||0,e.z||0),this._q.setFromEuler(this._d),this._s.set(i.x||1,i.y||1,i.z||1),this._v.set(t.x,t.y,t.z),this._matrix.identity().compose(this._v,this._q,this._s),this._matrix}}let qe,Qe,Ye,Ke,Ze=1;class Xe{constructor(){this.mp=new Map,this.fixUpdate=this.fixUpdate.bind(this)}fixUpdate(){for([Le,Ne]of this.mp)Ne.time?(Ne.time-=1,Ne.time>1||(Ne.func(),this.mp.delete(Le))):this.mp.delete(Le)}run(t,e,i){return i&&this.mp.has(i)?(this.mp.get(i).time=e,i):(Ze+=1,Ze>65530&&(Ze=1),this.mp.set(Ze,{func:t,time:e}),Ze)}arun(t,e,i){return new Promise(((a,r)=>{this.run((async()=>{await t(),a(Ze)}),e,i)}))}multiRun(t,e,i){for(let a=0;a<t;a++)this.run((()=>{i()}),a*e)}}class $e{constructor(){if(qe)return qe;qe=this,this.geos=this.mats=this.texs=this.fonts={},this.models={}}Colors(){return{blueLight:8163746,blue:5531009,brown:8946294,brownDark:4407117,gray:8034733,grayWhite:11912642,grayDark:4539729,green:6516591,white:14343888,yellow:15126438}}}class Je{constructor(){this._arr=[]}fixUpdate(){for(Qe=this._arr.length-1;Qe>=0;Qe--)Ye=this._arr[Qe](),Ye&&this._arr.splice(Qe,1)}run(t){this._arr.push(t)}}class ti extends class{async start(t={}){this._mainDom=t.dom,await de.load(t),await this._initLoad(t)}async _initLoad(t){globalThis.core=e,this.shader=new a;const i={dom:this._mainDom,background:t.background||1053717,fogColor:t.fogColor||1055524,...t};this.scene=new b(i),i.useDeferred||this._initComposer(t);const r=this.activeClass(Ae,this.scene);this.cameraControl=r,this.light=this.activeClass(Ve,this),this.phy=new de,await this.phy.start(t),this.phy.update&&this.scene.addUpdate(this.phy.update),this.phy.fixUpdate&&this.scene.addFixUpdate(this.phy.fixUpdate),this._addUI()}_addUI(){this.UIFunc=new r;const t=new ue(this.scene);this.scene.addEndUpdate(t.render),this.scene.uiScene=t,this.UIScene=t}_initComposer(t){const e={...this.scene,bloom:t.bloom,ssao:t.ssao},i=new fe(e);e.vignette&&(i.vignette.uniforms.offset.value=.2,i.vignette.uniforms.darkness.value=1),e.bloom&&(i.bloom.exposure=t.exposure||.5,i.bloom.strength=t.strength||.6,i.bloom.threshold=t.threshold||.1,i.bloom.radius=.3),this.scene.composer=i}activeClass(t,...e){if(!t)return;const i=new t(...e);return i.mesh&&this.scene.add(i.mesh),i.update&&this.scene.addUpdate(i.update.bind(i)),i.fixUpdate&&this.scene.addFixUpdate(i.fixUpdate.bind(i)),i.slowUpdate&&this.scene.addSlowUpdate(i.slowUpdate.bind(i)),i}activeUIClass(t,e,i){const a=new t(e,i);return a.mesh&&this.UIScene.add(a.mesh),a.update&&this.scene.addUpdate(a.update.bind(a)),a.fixUpdate&&this.scene.addFixUpdate(a.fixUpdate.bind(a)),a.slowUpdate&&this.scene.addSlowUpdate(a.slowUpdate.bind(a)),a}}{constructor(){if(super(),Ke)return Ke;Ke=this}async start(t,e){if(e.DEBUG,t.dom||(t.dom=this._makeDom(t)),this.dom=t.dom,this._checkWebGL())throw Error("WebGL error");let i={dom:null,fullScreen:!0};i={...i,...t},await super.start(i),await this.startBasic(e),await this.globalStart(e),e.dom=t.dom,e.w=this.scene.w,e.h=this.scene.h}_checkWebGL(){if(!THREE.WEBGL.isWebGLAvailable()){const t=THREE.WEBGL.getWebGLErrorMessage();return this.dom.appendChild(t),!0}}_makeDom(t){const e=document.createElement("div");return e.style.cssText=`\n        width: ${t.fullScreen?"100vw":t.width+"px"};\n        height: ${t.fullScreen?"100vh":t.height+"px"};\n        user-select: none;\n        -webkit-user-select: none;\n        background: none;\n        position: absolute;\n        left: 0;\n        top: 0;\n        z-index: 1;\n        `,e.id="main",document.body.appendChild(e),e}async globalStart(t){t.core=Oe;const e=new $e;t.ZCache=e;const i="rgba(255, 255, 255, 1)";t.ZCache.texs.circle=t.UIFunc.makeTexture(THREE,0,16,i),t.ZCache.texs.point=t.UIFunc.makeTexture(THREE,8,16,i),t.ZCache.texs.pointBig=t.UIFunc.makeTexture(THREE,8,64,"rgba(255, 255, 255, 0.8)")}async startBasic(e){this.event=Ue,this.Func=new Ge;const i=this,a=new t;i.activeClass=a.activeClass.bind(i),i.activeUIClass=a.activeUIClass.bind(i);const r=i.activeClass(Xe);this.delayRun=r.run.bind(r),this.delayMulti=r.multiRun.bind(r);const n=i.activeClass(Je);this.fixRun=n.run.bind(n),e.start(this)}}export{ti as default};
